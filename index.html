<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Njangi â€“ The Young Shall Grow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1220;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    h2 { margin-top: 0; }
    .card {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      max-width: 420px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
    }
    button { cursor: pointer; }
    .ok { color: #22c55e; }
    .bad { color: #ef4444; }
    .small { font-size: 12px; color: #9ca3af; }
  </style>
</head>

<body>

<h2>Njangi Dashboard</h2>

<!-- AUTH -->
<div class="card">
  <h3>Admin Login</h3>
  <input id="email" placeholder="Admin email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <div id="authStatus" class="small"></div>
</div>

<!-- KPI -->
<div class="card">
  <h3>Key Figures</h3>
  Njangi Pot: <b id="kPot">$0</b><br/>
  Foundation: <b id="kFoundation">$0</b><br/>
  Total Interest: <b id="kInterest">$0</b><br/>
  Next Payout Date: <b id="kNext">â€”</b>
</div>

<!-- ADD MEMBER -->
<div class="card">
  <h3>Add Member</h3>
  <input id="memberName" placeholder="Member full name" />
  <button onclick="addMember()">Add Member</button>
</div>

<!-- PAYOUT -->
<div class="card">
  <h3>Bi-Weekly Payout</h3>
  <div class="small">Rotation starts Jan 3 â€¢ Every 14 days</div>
  <button onclick="runPayout()">Run Payout</button>
</div>

<script>
/* =========================================================
   1) SUPABASE CONFIG  (PASTE ONLY HERE)
========================================================= */
const SUPABASE_URL = "https://auxdvufuhdnlalupwrrb.supabase.co // ðŸ‘ˆ PASTE HERE
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eGR2dWZ1aGRubGFsdXB3cnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjk2NzcsImV4cCI6MjA3Njc0NTY3N30.BLZ6Xl8O2_edvq5cLgksGwNZn3lByZqUlT_uYNMa7bs";       // ðŸ‘ˆ PASTE HERE

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================================================
   2) GLOBAL STATE
========================================================= */
let isAdmin = false;
let members = {};
let appState = {};

const BIWEEK_MS = 14 * 24 * 60 * 60 * 1000;

/* =========================================================
   3) AUTH
========================================================= */
async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  document.getElementById("authStatus").innerHTML =
    error ? `<span class="bad">${error.message}</span>` : `<span class="ok">Logged in</span>`;

  await loadAll();
}

/* =========================================================
   4) LOAD DATA
========================================================= */
async function loadAll() {
  const { data: userData } = await supabase.auth.getUser();
  if (userData?.user) {
    const { data: profile } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", userData.user.id)
      .single();
    isAdmin = profile?.role === "admin";
  }

  const { data: app } = await supabase.from("app_state").select("*").eq("id", 1).single();
  appState = app || {};

  const { data: mems } = await supabase.from("members").select("*").order("position");
  members = {};
  (mems || []).forEach(m => members[m.id] = m);

  updateUI();
}

/* =========================================================
   5) UI
========================================================= */
function money(x) { return "$" + (Number(x) || 0).toLocaleString(); }

function updateUI() {
  const pot = Object.values(members).reduce((s, m) => s + Number(m.contributed || 0), 0);

  document.getElementById("kPot").textContent = money(pot);
  document.getElementById("kFoundation").textContent = money(appState.foundation || 0);
  document.getElementById("kInterest").textContent = money(appState.total_interest_generated || 0);
  document.getElementById("kNext").textContent =
    appState.next_payout_date ? new Date(appState.next_payout_date).toDateString() : "â€”";
}

/* =========================================================
   6) ACTIONS
========================================================= */
async function addMember() {
  if (!isAdmin) return alert("Admin only");

  const name = document.getElementById("memberName").value.trim();
  if (!name) return alert("Enter name");

  const pos = Object.keys(members).length + 1;
  await supabase.from("members").insert({ name, position: pos });

  document.getElementById("memberName").value = "";
  await loadAll();
}

async function runPayout() {
  if (!isAdmin) return alert("Admin only");

  const today = new Date();
  const nextDate = new Date(appState.next_payout_date + "T00:00:00");
  if (today < nextDate) {
    return alert("Too early. Next payout: " + nextDate.toDateString());
  }

  const ids = Object.keys(members);
  if (!ids.length) return alert("No members");

  const idx = appState.next_payout_index || 0;
  const member = members[ids[idx]];

  const pot = Object.values(members).reduce((s, m) => s + Number(m.contributed || 0), 0);
  if (pot <= 0) return alert("Pot is empty");

  await supabase.from("payouts").insert({
    member_id: member.id,
    member_name: member.name,
    payout_amount: pot,
    payout_date: today.toISOString().slice(0,10)
  });

  await supabase.from("members").update({ contributed: 0 });
  await supabase.from("members")
    .update({ payout_total: (member.payout_total || 0) + pot })
    .eq("id", member.id);

  await supabase.from("app_state").update({
    next_payout_index: (idx + 1) % ids.length,
    next_payout_date: new Date(nextDate.getTime() + BIWEEK_MS).toISOString().slice(0,10)
  }).eq("id", 1);

  alert(`Paid ${money(pot)} to ${member.name}`);
  await loadAll();
}

/* =========================================================
   INIT
========================================================= */
loadAll();
</script>

</body>
</html>
