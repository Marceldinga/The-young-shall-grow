<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TheYoungShallGrow Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070b18;
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(255,255,255,.03);
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --shadow2: 0 10px 24px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(125,211,252,.22), transparent 55%),
        radial-gradient(900px 700px at 85% 25%, rgba(167,139,250,.18), transparent 60%),
        radial-gradient(1200px 900px at 45% 95%, rgba(52,211,153,.10), transparent 55%),
        linear-gradient(180deg, #060815, #070b18 45%, #070b18);
      color:var(--text);
      min-height:100vh;
    }

    #locked{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:22px}
    .lockBox{
      width:min(440px,100%);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .lockGrid{display:grid;grid-template-columns:1fr;gap:10px}
    input,select,textarea{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    textarea{min-height:96px;resize:vertical}
    input::placeholder,textarea::placeholder{color:rgba(234,240,255,.55)}
    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(135deg, rgba(125,211,252,.22), rgba(167,139,250,.18)),
        rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      box-shadow:var(--shadow2);
      transition: transform .10s ease, filter .10s ease;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform: translateY(1px)}
    .btn.ghost{background:rgba(255,255,255,.03);box-shadow:none;}

    .wrap{display:flex;min-height:100vh}
    .sidebar{
      width:330px;
      padding:16px;
      border-right:1px solid var(--border);
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .main{flex:1;padding:18px}
    .brand{
      font-weight:900;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow:0 0 22px rgba(125,211,252,.35);
    }
    .sub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      margin-top:14px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(12px);
    }
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      font-size:12px;
      color:rgba(234,240,255,.85);
    }
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:14px}
    .nav button{
      width:100%;
      text-align:left;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--text);
      cursor:pointer;
      transition: filter .1s ease;
    }
    .nav button:hover{filter:brightness(1.08)}
    .nav button.active{
      border-color:rgba(125,211,252,.45);
      box-shadow:0 0 0 1px rgba(125,211,252,.22) inset;
      background:rgba(125,211,252,.06);
    }

    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
    .title{font-size:18px;font-weight:900}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .val{font-size:22px;font-weight:900;margin-top:6px}
    .section{display:none}
    .section.active{display:block}

    label{display:block;color:var(--muted);font-size:12px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:12px;vertical-align:top}
    th{color:var(--muted);font-weight:800}
    .err{color:#fecaca;white-space:pre-wrap;font-size:12px;margin-top:10px;display:none}

    #toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(234,240,255,.92);
      padding:10px 14px;
      border-radius:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:none;
      z-index:9999;
      max-width:min(520px,92vw);
      font-size:13px;
    }

    @media (max-width:1100px){
      .grid4{grid-template-columns:1fr 1fr}
      .grid2{grid-template-columns:1fr}
      .sidebar{width:100%;max-width:360px}
    }

    /* ✅ makes charts render correctly */
    #histChart, #pieChart{
      width:100% !important;
      height:260px !important;
      display:block;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="locked">
  <div class="lockBox">
    <div class="lockGrid">
      <input id="email" placeholder="Email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      <button class="btn" onclick="signIn()">Sign in</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap" style="display:none;">
  <aside class="sidebar">
    <div class="brand"><span class="dot"></span> TheYoungShallGrow: Progress</div>
    <div class="sub">Today • <span id="today"></span></div>

    <div class="card">
      <div class="row"><span class="sub">Signed in</span><span class="pill" id="who">—</span></div>
      <div class="row" style="margin-top:10px;"><span class="sub">Role</span><span class="pill" id="role">—</span></div>
      <button class="btn ghost" style="width:100%;margin-top:10px" onclick="signOut()">Logout</button>
      <div id="sideErr" class="err"></div>
    </div>

    <div class="nav">
      <button id="navDash" class="active" onclick="show('dash','Dashboard')">Dashboard</button>
      <button id="navMembers" onclick="show('members','Members')">Members</button>
      <button id="navContrib" onclick="show('contrib','Contributions')">Contributions</button>
      <button id="navLoans" onclick="show('loans','Loans')">Loans</button>
      <button id="navFines" onclick="show('fines','Fines')">Fines</button>
      <button id="navPayouts" onclick="show('payouts','Payouts')">Payouts</button>
      <button id="navHistory" onclick="show('history','History')">History</button>
      <button id="navFPayments" onclick="show('foundation_payments','Foundation Payments')">Foundation Payments</button>

      <button class="btn ghost" style="margin-top:6px" onclick="reloadAll()">Refresh</button>
    </div>

    <div class="card">
      <div class="sub"><b>Rotation</b></div>
      <div style="margin-top:8px;font-weight:900;font-size:18px" id="nextName">—</div>
      <div class="sub" id="nextInfo">—</div>
      <button class="btn" style="width:100%;margin-top:10px" onclick="runPayout()">Run Payout</button>
      <div class="sub" style="margin-top:10px;color:#fbbf24">Start: <b>Jan 3, 2026</b> • Every 14 days</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title" id="pageTitle">Dashboard</div>
      <span class="pill" id="interestPill">Total Interest: <b id="kInterestMini">$0</b></span>
    </div>

    <section id="dash" class="section active">
      <div class="grid4">
        <div class="card kpi"><div class="label">Njangi Pot</div><div class="val" id="kPot">$0</div><div class="sub">Sum of contributions</div></div>
        <div class="card kpi"><div class="label">Foundation</div><div class="val" id="kFoundation">$0</div><div class="sub">Available for loans</div></div>
        <div class="card kpi"><div class="label">Outstanding Loans</div><div class="val" id="kLoans">$0</div><div class="sub">Total due</div></div>
        <div class="card kpi"><div class="label">Members</div><div class="val" id="kMembers">0</div><div class="sub">Rotation list</div></div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="card">
          <div class="row"><div style="font-weight:900;">Histogram: Contributions (Top 10)</div><span class="pill">Now</span></div>
          <canvas id="histChart"></canvas>
        </div>
        <div class="card">
          <div class="row"><div style="font-weight:900;">Pie: Pot vs Foundation vs Loans</div><span class="pill">Now</span></div>
          <canvas id="pieChart"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div style="font-weight:900;">Recent Activity</div><span class="pill">Top 15</span></div>
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Member</th><th>Amount</th><th>Interest %</th><th>Total Due</th></tr></thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>
    </section>

    <section id="members" class="section">
      <div class="grid2">
        <div class="card" id="cardAddMember">
          <div style="font-weight:900;">Add Member</div>
          <label>Name</label><input id="mName" placeholder="e.g. John Doe" />
          <label>Phone (optional)</label><input id="mPhone" placeholder="e.g. 301-000-0000" />
          <label>Has benefits?</label>
          <select id="mBenefits"><option value="false">No</option><option value="true">Yes</option></select>
          <button class="btn" style="width:100%;margin-top:12px" onclick="addMember()">Add Member</button>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900;">Member List</div><span class="pill">Total: <span id="memberCount">0</span></span></div>
          <table>
            <thead><tr><th>Name</th><th>Njangi</th><th>Foundation</th><th>Loan Due</th><th>Payout Total</th><th>Benefits</th></tr></thead>
            <tbody id="memberBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="contrib" class="section">
      <div class="grid2">
        <div class="card" id="cardAddContrib">
          <div style="font-weight:900;">Add Contribution</div>
          <label>Member</label><select id="cMember"></select>
          <label>Amount (multiple of 500)</label><input id="cAmount" type="number" placeholder="e.g. 500" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="addContribution()">Save Contribution</button>
          <div class="sub" style="margin-top:12px">Rule: Contributions must be multiples of <b>500</b>.</div>
        </div>
        <div class="card">
          <div style="font-weight:900;">Contributions Info</div>
          <div class="sub" style="margin-top:6px">This page only records contributions.</div>
        </div>
      </div>
    </section>

    <section id="loans" class="section">
      <div class="grid2">
        <div class="card" id="cardLoansForm">
          <div style="font-weight:900;">Issue Loan (5%) — Saved into Loans + Deducts Foundation Pot</div>

          <label>Surety (select member)</label><select id="lSuretyMember"></select>
          <label>Borrower (select member)</label><select id="lMember"></select>
          <label>Loan amount</label><input id="lAmount" type="number" placeholder="e.g. 1000" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="issueLoan()">Issue Loan</button>

          <div class="sub" style="margin-top:12px">
            Rules:
            <br>1) Borrower must pick a qualified surety.
            <br>2) 15-days rule is from SEASON start date.
            <br>3) Surety must be qualified to borrow AND not surety for another active loan.
          </div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.08);margin:14px 0;">

          <div style="font-weight:900;">Record Repayment</div>
          <label>Borrower (select member)</label><select id="rMember"></select>
          <label>Repayment amount</label><input id="rAmount" type="number" placeholder="e.g. 500" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="repayLoan()">Save Repayment</button>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900;">Loans</div><span class="pill">Newest first</span></div>
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Borrower</th><th>Surety</th><th>Principal</th><th>Interest</th><th>Total Due</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="loanBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="fines" class="section">
      <div class="grid2">
        <div class="card" id="cardFineForm">
          <div style="font-weight:900;">Add Fine</div>
          <label>Member</label><select id="fineMember"></select>
          <label>Fine amount</label><input id="fineAmount" type="number" placeholder="e.g. 500" />
          <label>Reason</label><input id="fineReason" placeholder="Late payment..." />
          <button class="btn" style="width:100%;margin-top:12px" onclick="addFine()">Save Fine</button>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900;">Fines</div><span class="pill">Newest first</span></div>
          <table>
            <thead><tr><th>Date</th><th>Member</th><th>Amount</th><th>Reason</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="fineBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="payouts" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Run Payout</div>
          <div class="sub" style="margin-top:6px;">Start: Jan 3, 2026 • Every 14 days</div>
          <button class="btn" style="width:100%;margin-top:12px" onclick="runPayout()">Run Now</button>
        </div>

        <div class="card">
          <div style="font-weight:900;">Payout History</div>
          <table>
            <thead><tr><th>Date</th><th>Member</th><th>Amount</th></tr></thead>
            <tbody id="payoutBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="history" class="section">
      <div class="card">
        <div class="row"><div style="font-weight:900;">Full History</div><span class="pill">Latest first</span></div>
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Member</th><th>Amount</th><th>Interest %</th><th>Total Due</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </section>

    <section id="foundation_payments" class="section">
      <div class="grid2">
        <div class="card" id="cardFpForm">
          <div style="font-weight:900;">Add Foundation Payment</div>
          <label>Member</label><select id="fpMember"></select>
          <label>Amount Paid</label><input id="fpPaid" type="number" placeholder="e.g. 500" />
          <label>Amount Pending</label><input id="fpPending" type="number" placeholder="e.g. 1500" />
          <label>Status</label>
          <select id="fpStatus">
            <option value="pending">pending</option>
            <option value="partial">partial</option>
            <option value="paid">paid</option>
          </select>
          <label>Notes (optional)</label><textarea id="fpNotes" placeholder="Notes..."></textarea>
          <button class="btn" style="width:100%;margin-top:12px" onclick="addFoundationPayment()">Save</button>
          <div class="sub" style="margin-top:10px">DatePaid is auto (now()).</div>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900;">Foundation Payments</div><span class="pill">Newest first</span></div>
          <table>
            <thead><tr><th>Date</th><th>Member</th><th>Paid</th><th>Pending</th><th>Status</th><th>Notes</th></tr></thead>
            <tbody id="fpBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<div id="toast"></div>

<script>
/* ===========================
   SUPABASE CONFIG
=========================== */
const SUPABASE_URL = "https://ficlrtvrrzfiakmciwel.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY2xydHZycnpmaWFrbWNpd2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjk0MDQsImV4cCI6MjA4MjcwNTQwNH0.xWuH_-amYd_24R8PURbZXMUDjz--Q9R_RASOdGzsZJI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===========================
   CONSTANTS
=========================== */
const ROTATION_START = new Date("2026-01-03T00:00:00");
const INTEREST_RATE = 0.05;
const SURETY_PENDING_MAX_DAYS = 15;

/* ===========================
   STATE
=========================== */
let appState = { foundation:0, total_interest_generated:0, next_payout_index:0, next_payout_date:"2026-01-03", rotation_start_date:"2026-01-03" };
let members = [];
let history = [];
let payouts = [];
let fines = [];
let foundationPayments = [];
let loans = [];
let latestSession = null;
let contribTotalsByMember = {};

/* ✅ role */
let currentUserRole = "member";

/* ✅ charts */
let _histChart = null;
let _pieChart = null;

/* ===========================
   HELPERS
=========================== */
const money = (x) => "$" + (Number(x)||0).toLocaleString();
const fromIso = (s) => new Date(s + "T00:00:00");

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(() => { el.style.display = "none"; }, 2800);
}
function sideErr(msg){
  const el = document.getElementById("sideErr");
  el.style.display = msg ? "block" : "none";
  el.textContent = msg || "";
}
function appendErr(msg){
  const el = document.getElementById("sideErr");
  const current = el.textContent || "";
  const next = current ? (current + "\n" + msg) : msg;
  el.style.display = "block";
  el.textContent = next;
}
function setDisabled(el, disabled){
  if(!el) return;
  el.disabled = !!disabled;
  el.style.opacity = disabled ? "0.55" : "";
  el.style.pointerEvents = disabled ? "none" : "";
}

/* ✅ admin-only UI lock */
function applyRoleUI(){
  const isAdmin = (currentUserRole === "admin");

  document.getElementById("role").textContent = currentUserRole;

  // hide interest pill for non-admin
  const pill = document.getElementById("interestPill");
  if(pill) pill.style.display = isAdmin ? "inline-block" : "none";

  // disable all write forms for non-admin
  const cards = ["cardAddMember","cardAddContrib","cardLoansForm","cardFineForm","cardFpForm"];
  cards.forEach(id=>{
    const card = document.getElementById(id);
    if(!card) return;
    card.querySelectorAll("input,select,textarea,button").forEach(el => setDisabled(el, !isAdmin));
  });

  // payout button admin-only
  document.querySelectorAll('button[onclick="runPayout()"]').forEach(btn => setDisabled(btn, !isAdmin));
}

function show(sectionId, title){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(sectionId).classList.add("active");
  document.getElementById("pageTitle").textContent = title;

  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  const map = {
    dash:"navDash",
    members:"navMembers",
    contrib:"navContrib",
    loans:"navLoans",
    fines:"navFines",
    payouts:"navPayouts",
    history:"navHistory",
    foundation_payments:"navFPayments",
  };
  document.getElementById(map[sectionId])?.classList.add("active");

  // ✅ ensure charts resize after tab switch
  if(sectionId === "dash"){
    setTimeout(()=>{ try{ _histChart?.resize(); _pieChart?.resize(); }catch(e){} }, 60);
  }
}

window.addEventListener("error", (e) => appendErr("JS error: " + (e?.message || "unknown")));
window.addEventListener("unhandledrejection", (e) => appendErr("Promise error: " + (e?.reason?.message || String(e?.reason || "unknown"))));

/* ===========================
   ✅ CHARTS (FIX: chart present but not showing)
=========================== */
function renderCharts(pot, foundation, loansTotal){
  // Histogram: top 10 contributors
  const top = (members || [])
    .map(m => ({ name: m.name || String(m.id), val: Number(m.contributed || 0) }))
    .sort((a,b)=>b.val-a.val)
    .slice(0,10);

  const hctx = document.getElementById("histChart")?.getContext("2d");
  if(hctx){
    if(_histChart) _histChart.destroy();
    _histChart = new Chart(hctx, {
      type: "bar",
      data: {
        labels: top.map(x=>x.name),
        datasets: [{ label: "Contributions", data: top.map(x=>x.val) }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: false } }
      }
    });
  }

  const pctx = document.getElementById("pieChart")?.getContext("2d");
  if(pctx){
    const a = Number(pot||0), b = Number(foundation||0), c = Number(loansTotal||0);
    const sum = a+b+c;

    // if all zero, show placeholder slices so pie is visible
    const pieData = (sum<=0) ? [1,1,1] : [a,b,c];

    if(_pieChart) _pieChart.destroy();
    _pieChart = new Chart(pctx, {
      type: "pie",
      data: {
        labels: ["Pot","Foundation","Loans"],
        datasets: [{ data: pieData }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          title: { display: (sum<=0), text:"No data yet (all totals are 0)" }
        }
      }
    });
  }
}

/* ===========================
   SEASON-BASED 15-DAYS + QUALIFIED SURETY
   (UNCHANGED)
=========================== */
function getSeasonStartDate(){
  const s = (appState && appState.rotation_start_date) ? String(appState.rotation_start_date) : null;
  if(s && /^\d{4}-\d{2}-\d{2}$/.test(s)) return fromIso(s);
  return ROTATION_START;
}
function daysSinceSeasonStart(){
  const start = getSeasonStartDate();
  const ms = Date.now() - start.getTime();
  return Math.floor(ms / (24*60*60*1000));
}
function seasonIsBeyond15Days(){
  return daysSinceSeasonStart() > SURETY_PENDING_MAX_DAYS;
}
function memberHasPendingFoundation(memberId){
  const rows = (foundationPayments || [])
    .filter(r => String(r.member_id) === String(memberId))
    .filter(r => Number(r.amount_pending || 0) > 0)
    .filter(r => {
      const st = String(r.status || "").toLowerCase();
      return st === "pending" || st === "partial";
    });
  return rows.length > 0;
}
function isAlreadySuretyOnActiveLoan(memberId){
  return (loans || []).some(l =>
    String(l.surety_member_id) === String(memberId) &&
    String(l.status || "").toLowerCase() === "active"
  );
}
function qualifiedToBorrow(memberObj, loanAmt){
  if(!memberObj) return { ok:false, reason:"Member not found" };

  if(seasonIsBeyond15Days() && memberHasPendingFoundation(memberObj.id)){
    return { ok:false, reason:`Not qualified: pending foundation after ${SURETY_PENDING_MAX_DAYS} days from season start` };
  }

  const amt = Number(loanAmt || 0);
  if(amt > 0 && memberObj.has_benefits){
    const minReq = 0.70 * amt;
    const contrib = Number(memberObj.foundation_contrib || 0);
    if(contrib <= minReq){
      return { ok:false, reason:"Not qualified (benefits rule)" };
    }
  }

  return { ok:true, reason:"Qualified" };
}
function qualifiedSurety(memberObj, borrowerId, loanAmt){
  const q = qualifiedToBorrow(memberObj, loanAmt);
  if(!q.ok) return q;

  if(String(memberObj.id) === String(borrowerId)){
    return { ok:false, reason:"Surety cannot be borrower" };
  }
  if(isAlreadySuretyOnActiveLoan(memberObj.id)){
    return { ok:false, reason:"Not qualified: already surety for another active loan" };
  }
  return { ok:true, reason:"Surety qualified" };
}
function refreshSuretyDropdown(){
  const suretySel = document.getElementById("lSuretyMember");
  const borrowerSel = document.getElementById("lMember");
  const amtInput = document.getElementById("lAmount");
  if(!suretySel || !borrowerSel || !amtInput) return;

  const borrowerId = borrowerSel.value || "";
  const amt = Number(amtInput.value || 0);

  const options = (members || [])
    .filter(m => qualifiedSurety(m, borrowerId, amt).ok)
    .map(m => `<option value="${m.id}">${m.name}</option>`)
    .join("");

  suretySel.innerHTML = options || `<option value="">No qualified surety available</option>`;
}

/* ===========================
   ✅ AUTH (FIX: members can login, but restricted)
=========================== */
async function enforceAdminGate(){
  const { data } = await sb.auth.getUser();
  const user = data?.user;

  if(!user){
    document.getElementById("app").style.display = "none";
    document.getElementById("locked").style.display = "flex";
    return false;
  }

  const { data: profile, error } = await sb
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .maybeSingle();

  if(error){
    sideErr("profiles: " + error.message);
    await sb.auth.signOut();
    document.getElementById("app").style.display = "none";
    document.getElementById("locked").style.display = "flex";
    return false;
  }

  if(!profile){
    sideErr("profiles: no row for this user (create a profiles row + role='admin' or role='member').");
    await sb.auth.signOut();
    document.getElementById("app").style.display = "none";
    document.getElementById("locked").style.display = "flex";
    return false;
  }

  const role = String(profile.role || "").toLowerCase();
  currentUserRole = (role === "admin") ? "admin" : "member";

  document.getElementById("locked").style.display = "none";
  document.getElementById("app").style.display = "flex";
  document.getElementById("who").textContent = user.email || "user";
  document.getElementById("today").textContent = new Date().toLocaleDateString();

  applyRoleUI();
  return true;
}

async function signIn(){
  sideErr("");
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if (!email || !password) return toast("Enter email and password");

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) return toast(error.message);

  const ok = await enforceAdminGate();
  if (!ok) return toast("Login failed");

  await reloadAll();
  toast("Welcome");
}
async function signOut(){
  await sb.auth.signOut();
  document.getElementById("app").style.display = "none";
  document.getElementById("locked").style.display = "flex";
}

/* ===========================
   LOAD (UNCHANGED)
=========================== */
async function reloadAll(){
  sideErr("");

  let a = await sb.from("app_state").select("*").eq("id", 1).maybeSingle();
  if (a.error) {
    appendErr("app_state: " + a.error.message);
  } else if (!a.data) {
    const seed = {
      id: 1,
      foundation: 0,
      next_payout_index: 0,
      rotation_start_date: "2026-01-03",
      next_payout_date: "2026-01-03",
      total_interest_generated: 0,
      updated_at: new Date().toISOString()
    };
    const ins = await sb.from("app_state").insert([seed]).select().single();
    if (ins.error) appendErr("app_state init: " + ins.error.message);
    else appState = ins.data;
  } else {
    appState = a.data;
  }

  const m = await sb.from("members").select("*").order("position", { ascending: true });
  if (m.error) appendErr("members: " + m.error.message);
  members = m.data || [];

  const c = await sb.from("contributions").select("member_id, amount").eq("kind", "contribution").limit(5000);
  if (c.error) appendErr("contributions: " + c.error.message);

  const totals = {};
  (c.data || []).forEach(r => {
    const mid = String(r.member_id);
    totals[mid] = (totals[mid] || 0) + (Number(r.amount) || 0);
  });
  contribTotalsByMember = totals;
  members = (members || []).map(mem => ({ ...mem, contributed: totals[String(mem.id)] || 0 }));

  const h = await sb.from("history").select("*").order("created_at", { ascending: false }).limit(500);
  if (h.error) appendErr("history: " + h.error.message);
  history = h.data || [];

  const p = await sb.from("payouts").select("*").order("created_at", { ascending: false }).limit(200);
  if (p.error) appendErr("payouts: " + p.error.message);
  payouts = p.data || [];

  const f = await sb.from("fines").select("*").order("created_at", { ascending: false }).limit(200);
  if (f.error) appendErr("fines: " + f.error.message);
  fines = f.data || [];

  const fp = await sb.from("foundation_payments").select("*").order("date_paid", { ascending: false }).limit(300);
  if (fp.error) appendErr("foundation_payments: " + fp.error.message);
  foundationPayments = fp.data || [];

  const l = await sb.from("loans").select("*").order("created_at", { ascending: false }).limit(300);
  if (l.error) appendErr("loans: " + l.error.message);
  loans = l.data || [];

  const sess = await sb.from("sessions").select("*").order("start_date", { ascending: false }).limit(1).maybeSingle();
  if (sess.error) appendErr("sessions: " + sess.error.message);
  latestSession = sess.data || null;

  renderAll();
  refreshSuretyDropdown();
  applyRoleUI();
}

/* ===========================
   RENDER (ONLY added charts call + interest hide)
=========================== */
function renderAll(){
  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  const outstanding = members.reduce((s,x)=>s+(Number(x.loan_due)||0),0);

  document.getElementById("kPot").textContent = money(pot);
  document.getElementById("kFoundation").textContent = money(appState.foundation || 0);
  document.getElementById("kLoans").textContent = money(outstanding);
  document.getElementById("kMembers").textContent = String(members.length);

  // interest value only meaningful for admin, but pill is hidden for member by applyRoleUI()
  document.getElementById("kInterestMini").textContent = money(appState.total_interest_generated||0);

  const idx = Number(appState.next_payout_index||0);
  const nextDate = appState.next_payout_date ? fromIso(appState.next_payout_date) : ROTATION_START;
  const nextMember = members.length ? members[idx % members.length] : null;

  document.getElementById("nextName").textContent = nextMember ? nextMember.name : "No members";
  document.getElementById("nextInfo").textContent = members.length
    ? `Next payout: ${nextDate.toLocaleDateString()} • Position ${(idx%members.length)+1}/${members.length} • Payout: ${money(pot)}`
    : "Add members to start rotation";

  document.getElementById("memberCount").textContent = String(members.length);
  document.getElementById("memberBody").innerHTML = members
    .slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .map(x=>`
      <tr>
        <td>${x.name||""}</td>
        <td>${money(x.contributed||0)}</td>
        <td>${money(x.foundation_contrib||0)}</td>
        <td>${money(x.loan_due||0)}</td>
        <td>${money(x.payout_total||0)}</td>
        <td>${x.has_benefits ? "Yes":"No"}</td>
      </tr>
    `).join("");

  const opts = members.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
  ["cMember","fineMember","fpMember","lMember","rMember"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.innerHTML=opts;
  });

  const recent = history.slice(0,15);
  document.getElementById("recentBody").innerHTML = recent.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    return `<tr><td>${t}</td><td>${x.type||""}</td><td>${x.member||""}</td><td>${money(x.amount||0)}</td><td>${x.interest_percent?Number(x.interest_percent)+"%":"-"}</td><td>${x.total_due!=null?money(x.total_due):"-"}</td></tr>`;
  }).join("");

  document.getElementById("historyBody").innerHTML = history.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    return `<tr><td>${t}</td><td>${x.type||""}</td><td>${x.member||""}</td><td>${money(x.amount||0)}</td><td>${x.interest_percent?Number(x.interest_percent)+"%":"-"}</td><td>${x.total_due!=null?money(x.total_due):"-"}</td></tr>`;
  }).join("");

  document.getElementById("payoutBody").innerHTML = payouts.map(x=>`
    <tr><td>${x.payout_date||""}</td><td>${x.member_name||""}</td><td>${money(x.payout_amount||0)}</td></tr>
  `).join("");

  document.getElementById("fineBody").innerHTML = fines.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    const action = (x.status||"unpaid")==="unpaid"
      ? `<button class="btn ghost" onclick="markFinePaid(${x.id})">Mark Paid</button>`
      : "-";
    return `<tr><td>${t}</td><td>${x.member_name||""}</td><td>${money(x.amount||0)}</td><td>${x.reason||"-"}</td><td>${x.status||"unpaid"}</td><td>${action}</td></tr>`;
  }).join("");

  const membersById = Object.fromEntries(members.map(m => [String(m.id), m]));
  document.getElementById("fpBody").innerHTML = (foundationPayments || []).map(r=>{
    const t = r.date_paid ? new Date(r.date_paid).toLocaleString() : "";
    const m = membersById[String(r.member_id)];
    return `<tr>
      <td>${t}</td>
      <td>${m ? m.name : (r.member_id ?? "")}</td>
      <td>${money(r.amount_paid||0)}</td>
      <td>${money(r.amount_pending||0)}</td>
      <td>${r.status||""}</td>
      <td>${(r.notes||"")}</td>
    </tr>`;
  }).join("");

  document.getElementById("loanBody").innerHTML = (loans || []).map(r=>{
    const t = r.created_at ? new Date(r.created_at).toLocaleString() : "";
    return `<tr>
      <td>${t}</td>
      <td>${r.borrower_name || ""}</td>
      <td>${r.surety_name || ""}</td>
      <td>${money(r.principal||0)}</td>
      <td>${money(r.interest||0)}</td>
      <td>${money(r.total_due||0)}</td>
      <td>${r.status||""}</td>
    </tr>`;
  }).join("");

  // ✅ show charts
  renderCharts(pot, Number(appState.foundation||0), outstanding);
}

/* ===========================
   WRITES (UNCHANGED)
=========================== */
async function addHistoryRow(type, member, amount, interestPercent=0, totalDue=null){
  const r = await sb.from("history").insert([{ type, member, amount, interest_percent:interestPercent, total_due:totalDue }]);
  if(r.error) appendErr("history insert: " + r.error.message);
}

async function addMember(){
  const name = document.getElementById("mName").value.trim();
  const phone = document.getElementById("mPhone").value.trim();
  const hasBenefits = document.getElementById("mBenefits").value === "true";
  if(!name) return toast("Enter member name");

  const pos = members.length ? (Math.max(...members.map(x => Number(x.position || 0))) + 1) : 1;

  const r = await sb.from("members").insert([{ name, phone, has_benefits: hasBenefits, position: pos }]);
  if (r.error) return toast(r.error.message);

  await addHistoryRow("Member Added", name, 0, 0, null);
  document.getElementById("mName").value = "";
  document.getElementById("mPhone").value = "";
  await reloadAll();
  toast("Member added");
}

async function addContribution(){
  const memberIdStr = document.getElementById("cMember").value;
  const memberId = Number(memberIdStr);
  const amt = Number(document.getElementById("cAmount").value || 0);

  if(!memberIdStr) return toast("Select member");
  if(!amt || amt <= 0) return toast("Enter amount");
  if(amt % 500 !== 0) return toast("Must be multiple of 500");

  const m = members.find(x => String(x.id) === String(memberIdStr));
  const memberName = m?.name || "";

  const row = { member_id: memberId, amount: amt, kind: "contribution" };
  if(latestSession?.id) row.session_id = latestSession.id;

  const ins = await sb.from("contributions").insert([row]);
  if (ins.error) return toast(ins.error.message);

  const prev = Number(contribTotalsByMember[String(memberId)] || 0);
  const newTotal = prev + amt;

  await addHistoryRow("Contribution", memberName || ("member_id=" + memberId), amt, 0, newTotal);

  document.getElementById("cAmount").value = "";
  await reloadAll();
  toast("Saved");
}

/* LOANS / REPAY / FINES / FOUNDATION PAYMENTS / PAYOUT
   (your original code continues unchanged below)
*/
async function issueLoan(){ /* unchanged in your file */ toast("Use your original issueLoan() body here (kept unchanged)"); }
async function repayLoan(){ /* unchanged in your file */ toast("Use your original repayLoan() body here (kept unchanged)"); }
async function addFine(){ /* unchanged in your file */ toast("Use your original addFine() body here (kept unchanged)"); }
async function markFinePaid(){ /* unchanged in your file */ toast("Use your original markFinePaid() body here (kept unchanged)"); }
async function addFoundationPayment(){ /* unchanged in your file */ toast("Use your original addFoundationPayment() body here (kept unchanged)"); }
async function runPayout(){ /* unchanged in your file */ toast("Use your original runPayout() body here (kept unchanged)"); }

/* INIT */
(async function init(){
  document.getElementById("app").style.display="none";
  document.getElementById("locked").style.display="flex";
  const ok = await enforceAdminGate();
  if(ok) await reloadAll();

  const borrowerSel = document.getElementById("lMember");
  const amtInput = document.getElementById("lAmount");
  if(borrowerSel) borrowerSel.addEventListener("change", refreshSuretyDropdown);
  if(amtInput) amtInput.addEventListener("input", refreshSuretyDropdown);
})();
</script>
</body>
</html>
