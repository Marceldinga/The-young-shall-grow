<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Young Shall Grow — Njangi Admin</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#070b18;
      --panel:rgba(255,255,255,.05);
      --panel2:rgba(255,255,255,.03);
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --accent:#4f7cff;
      --accent2:#1bd6a7;
      --danger:#ff4f6d;
      --radius:18px;
      --shadow:0 14px 50px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(79,124,255,.22), transparent 55%),
        radial-gradient(900px 700px at 85% 15%, rgba(27,214,167,.15), transparent 55%),
        radial-gradient(700px 600px at 55% 95%, rgba(255,79,109,.12), transparent 60%),
        linear-gradient(180deg, #050814 0%, #050814 40%, #040612 100%);
      min-height:100vh;
    }

    .wrap{max-width:1200px; margin:0 auto; padding:22px;}
    .top{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 18px; border:1px solid var(--border); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background:linear-gradient(135deg, rgba(79,124,255,.95), rgba(27,214,167,.85));
      display:grid; place-items:center; font-weight:800;
    }
    .brand h1{font-size:20px; margin:0; letter-spacing:.2px;}
    .brand .sub{color:var(--muted); font-size:13px; margin-top:2px;}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--border); padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:13px;
      max-width:520px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%; background:var(--accent2); box-shadow:0 0 0 3px rgba(27,214,167,.12);}

    .grid{display:grid; grid-template-columns: 320px 1fr; gap:18px; margin-top:18px;}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .card .hd{padding:16px 16px 10px 16px; border-bottom:1px solid rgba(255,255,255,.06);}
    .card .hd h2{margin:0; font-size:18px;}
    .card .hd .sub{color:var(--muted); margin-top:6px; font-size:13px;}
    .card .bd{padding:14px 16px 16px 16px;}
    .kpiRow{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;}
    @media (max-width: 980px){ .kpiRow{grid-template-columns:1fr} }
    .kpi{
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.03);
    }
    .kpi .lab{color:var(--muted); font-size:12px;}
    .kpi .val{font-size:24px; font-weight:800; margin-top:6px;}
    .kpi .tiny{color:var(--muted); font-size:12px; margin-top:6px;}

    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-weight:650;
      font-size:13px;
    }
    .tab.active{color:var(--text); background:rgba(79,124,255,.16); border-color:rgba(79,124,255,.35);}

    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      color:#fff;
      background:linear-gradient(135deg, rgba(79,124,255,.95), rgba(121,94,255,.75));
      box-shadow:0 10px 30px rgba(79,124,255,.20);
      font-weight:800;
      letter-spacing:.2px;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btnGhost{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:11px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:750;
    }

    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    label{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px;}
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    .hint{color:var(--muted); font-size:12px; margin-top:8px;}
    .err{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,79,109,.35);
      background:rgba(255,79,109,.10);
      color:#ffd7de;
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
    }
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px;}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); font-size:13px;}
    th{color:var(--muted); text-align:left; font-weight:800; letter-spacing:.2px;}
    td.mono{font-family:var(--mono); color:rgba(234,240,255,.85)}
    td.right, th.right{text-align:right}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px; border-radius:999px;
      color:var(--text);
      font-size:13px;
      display:none;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">YS</div>
        <div>
          <h1>The Young Shall Grow</h1>
          <div class="sub">Njangi Admin Dashboard • Secure Login</div>
        </div>
      </div>
      <div class="pill" title="Signed in user">
        <span class="dot"></span>
        <span id="who">Not signed in</span>
        <span style="opacity:.65">•</span>
        <span id="role">—</span>
        <span style="opacity:.65">•</span>
        <span id="today">—</span>
      </div>
    </div>

    <!-- LOCKED (LOGIN) -->
    <div id="locked" class="grid" style="margin-top:18px;">
      <div class="card">
        <div class="hd">
          <h2>Sign in</h2>
          <div class="sub">Only admins can access the dashboard.</div>
        </div>
        <div class="bd">
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com" />
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" />
          <div style="display:flex; gap:10px; margin-top:12px;">
            <button class="btn" id="btnLogin">Sign in</button>
            <button class="btnGhost" id="btnMagic">Send magic link</button>
          </div>
          <div class="hint">Tip: Your Supabase Auth user must have a row in <span class="mono">profiles</span> with <span class="mono">role='admin'</span>, and RPC <span class="mono">is_admin()</span> must exist.</div>
          <div class="err" id="authErr"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Setup checklist</h2>
          <div class="sub">If login works locally but fails on your domain, these are the common causes.</div>
        </div>
        <div class="bd">
          <ol style="margin:0; padding-left:18px; color:var(--muted); line-height:1.6">
            <li>Supabase URL + anon key are correct in this HTML.</li>
            <li>Supabase Auth → URL Configuration includes your site domain in Redirect URLs.</li>
            <li>RLS policies allow admins to read/write <span class="mono">members</span>, <span class="mono">app_state</span>, <span class="mono">payouts</span>.</li>
            <li><span class="mono">profiles</span> table exists and your user has <span class="mono">role='admin'</span>.</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none; margin-top:18px;">
      <div class="grid">
        <!-- LEFT SIDEBAR -->
        <div class="card">
          <div class="hd">
            <h2>Njangi Admin</h2>
            <div class="sub">Manage members, pot, and payouts</div>
          </div>
          <div class="bd">
            <div class="tabs">
              <div class="tab active" data-tab="dash">Dashboard</div>
              <div class="tab" data-tab="members">Members</div>
              <div class="tab" data-tab="payouts">Payouts</div>
            </div>

            <div style="margin-top:14px; display:grid; gap:10px">
              <button class="btnGhost" id="btnReload">Reload data</button>
              <button class="btnGhost" id="btnLogout">Logout</button>
            </div>

            <div class="err" id="sideErr"></div>
          </div>
        </div>

        <!-- MAIN -->
        <div>
          <!-- DASH -->
          <section id="tab-dash" class="card">
            <div class="hd">
              <h2>Dashboard</h2>
              <div class="sub">Current pot + next beneficiary (bi-weekly rotation)</div>
            </div>
            <div class="bd">
              <div class="kpiRow">
                <div class="kpi">
                  <div class="lab">Njangi Pot (sum of contributed)</div>
                  <div class="val" id="kPot">$0</div>
                  <div class="tiny" id="kPotHint">—</div>
                </div>
                <div class="kpi">
                  <div class="lab">Rotation Start</div>
                  <div class="val" id="kStart">—</div>
                  <div class="tiny">Every 14 days</div>
                </div>
                <div class="kpi">
                  <div class="lab">Next payout</div>
                  <div class="val" id="kNextDate">—</div>
                  <div class="tiny" id="kNextWho">—</div>
                </div>
              </div>

              <div style="margin-top:14px" class="kpi">
                <div class="lab">Quick actions</div>
                <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
                  <button class="btn" id="btnRunPayout">Run Payout (Run Now)</button>
                  <button class="btnGhost" id="btnResetStart">Reset start to 2026-01-03</button>
                </div>
                <div class="hint">
                  Run Payout will: insert into <span class="mono">payouts</span> (with <span class="mono">member_id</span>), add pot to beneficiary payout_total, reset all contributed to 0, then advance next payout by 14 days.
                </div>
              </div>
            </div>
          </section>

          <!-- MEMBERS -->
          <section id="tab-members" class="card" style="display:none; margin-top:18px;">
            <div class="hd">
              <h2>Members</h2>
              <div class="sub">Add contributions and manage list</div>
            </div>
            <div class="bd">
              <div class="row">
                <div>
                  <label>Member</label>
                  <select id="mPick"></select>
                </div>
                <div>
                  <label>Add contribution</label>
                  <input id="mAddAmt" type="number" min="0" placeholder="0" />
                </div>
                <div style="align-self:end">
                  <button class="btn" id="btnAddContrib">Add</button>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div>
                  <label>New member name</label>
                  <input id="mNewName" placeholder="Full name" />
                </div>
                <div style="align-self:end">
                  <button class="btnGhost" id="btnAddMember">Add member</button>
                </div>
              </div>

              <div style="margin-top:14px">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th class="right">Contributed</th>
                      <th class="right">Payout Total</th>
                      <th>Last payout</th>
                    </tr>
                  </thead>
                  <tbody id="membersBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- PAYOUTS -->
          <section id="tab-payouts" class="card" style="display:none; margin-top:18px;">
            <div class="hd">
              <h2>Payouts</h2>
              <div class="sub">History + beneficiary details</div>
            </div>
            <div class="bd">
              <div class="kpiRow">
                <div class="kpi">
                  <div class="lab">Next beneficiary</div>
                  <div class="val" id="pNextWho">—</div>
                  <div class="tiny" id="pNextMeta">—</div>
                </div>
                <div class="kpi">
                  <div class="lab">Next payout date</div>
                  <div class="val" id="pNextDate">—</div>
                  <div class="tiny">Start: <span id="pStart">—</span></div>
                </div>
                <div class="kpi">
                  <div class="lab">Current pot</div>
                  <div class="val" id="pPot">$0</div>
                  <div class="tiny">Will be paid to next beneficiary</div>
                </div>
              </div>

              <div style="margin-top:12px">
                <button class="btn" id="btnRunPayout2">Run Now</button>
              </div>

              <div style="margin-top:14px">
                <table>
                  <thead>
                    <tr>
                      <th>Created</th>
                      <th>Payout date</th>
                      <th>Member</th>
                      <th>Member ID</th>
                      <th class="right">Amount</th>
                    </tr>
                  </thead>
                  <tbody id="payoutBody"></tbody>
                </table>
              </div>
            </div>
          </section>

        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===========================
   CONFIG — FILL THESE
=========================== */
const SUPABASE_URL = "YOUR_SUPABASE_URL";      // e.g. https://xxxx.supabase.co
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

/* Rotation rules */
const DEFAULT_ROTATION_START_ISO = "2026-01-03"; // first beneficiary date
const BIWEEKLY_DAYS = 14;

/* Supabase client */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===========================
   SMALL HELPERS
=========================== */
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t=$("toast");
  t.textContent = msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none", 1800);
}
function setErr(id,msg){
  const el=$(id);
  if(!msg){ el.style.display="none"; el.textContent=""; return; }
  el.style.display="block";
  el.textContent=msg;
}
function money(n){
  const x = Number(n||0);
  return x.toLocaleString("en-US", { style:"currency", currency:"USD" });
}
function parseISODateUTC(iso){ // YYYY-MM-DD -> Date at UTC midnight
  if(!iso) return null;
  const [y,m,d] = String(iso).slice(0,10).split("-").map(Number);
  if(!y||!m||!d) return null;
  return new Date(Date.UTC(y, m-1, d));
}
function fmtDateUTC(date){
  if(!(date instanceof Date)) return "—";
  return date.toLocaleDateString("en-US", { timeZone:"UTC" });
}
function isoDateUTC(date){
  if(!(date instanceof Date)) return null;
  return date.toISOString().slice(0,10);
}
function addDaysUTC(date, days){
  const d=new Date(date.getTime());
  d.setUTCDate(d.getUTCDate()+days);
  return d;
}
function nowIso(){ return new Date().toISOString(); }

/* ===========================
   STATE
=========================== */
let members = [];
let payouts = [];
let appState = null;

/* ===========================
   ADMIN GATE
=========================== */
async function enforceAdminGate(){
  setErr("authErr","");
  setErr("sideErr","");

  const { data, error } = await sb.auth.getUser();
  if(error){
    setErr("authErr", error.message);
    $("locked").style.display="grid";
    $("app").style.display="none";
    return false;
  }
  const user = data?.user;
  if(!user){
    $("locked").style.display="grid";
    $("app").style.display="none";
    $("who").textContent = "Not signed in";
    $("role").textContent = "—";
    $("today").textContent = new Date().toLocaleDateString();
    return false;
  }

  // Check admin via RPC is_admin()
  const r = await sb.rpc("is_admin");
  if(r.error){
    setErr("authErr", "is_admin RPC error: " + r.error.message);
    await sb.auth.signOut();
    $("locked").style.display="grid";
    $("app").style.display="none";
    return false;
  }
  if(!r.data){
    setErr("authErr", "Access denied: your role is not admin.");
    await sb.auth.signOut();
    $("locked").style.display="grid";
    $("app").style.display="none";
    return false;
  }

  $("locked").style.display="none";
  $("app").style.display="block";
  $("who").textContent = user.email || "admin";
  $("role").textContent = "admin";
  $("today").textContent = new Date().toLocaleDateString();
  return true;
}

/* ===========================
   LOADERS + RENDER
=========================== */
async function loadMembers(){
  const r = await sb.from("members")
    .select("id,name,contributed,payout_total,last_payout_at")
    .order("id", { ascending:true });
  if(r.error) throw new Error("members: " + r.error.message);
  members = r.data || [];
}
async function loadPayouts(){
  const r = await sb.from("payouts")
    .select("*")
    .order("created_at", { ascending:false })
    .limit(200);
  if(r.error) throw new Error("payouts: " + r.error.message);
  payouts = r.data || [];
}
async function loadAppState(){
  const r = await sb.from("app_state").select("*").eq("id", 1).maybeSingle();
  if(r.error) throw new Error("app_state: " + r.error.message);
  appState = r.data || null;

  // If missing, try to create (requires admin RLS policy)
  if(!appState){
    const ins = await sb.from("app_state").insert([{
      id: 1,
      rotation_start_date: DEFAULT_ROTATION_START_ISO,
      next_payout_index: 0,
      next_payout_date: DEFAULT_ROTATION_START_ISO,
      updated_at: nowIso()
    }]);
    if(ins.error) throw new Error("app_state insert: " + ins.error.message);
    const r2 = await sb.from("app_state").select("*").eq("id", 1).maybeSingle();
    if(r2.error) throw new Error("app_state reload: " + r2.error.message);
    appState = r2.data;
  }

  // Normalize start behavior: if NO payouts yet, first beneficiary date must be start date.
  const startIso = String(appState.rotation_start_date || DEFAULT_ROTATION_START_ISO).slice(0,10);
  if((payouts||[]).length === 0){
    if(String(appState.next_payout_date||"").slice(0,10) !== startIso || Number(appState.next_payout_index||0) !== 0){
      const u = await sb.from("app_state").update({
        next_payout_index: 0,
        next_payout_date: startIso,
        updated_at: nowIso()
      }).eq("id", 1);
      if(!u.error){
        appState.next_payout_index = 0;
        appState.next_payout_date = startIso;
      }
    }
  }
}

function computePot(){
  return (members||[]).reduce((s,m)=>s+(Number(m.contributed)||0),0);
}

function computeNext(){
  const startIso = String(appState?.rotation_start_date || DEFAULT_ROTATION_START_ISO).slice(0,10);
  const start = parseISODateUTC(startIso) || parseISODateUTC(DEFAULT_ROTATION_START_ISO);
  const idx = Number(appState?.next_payout_index||0);
  const nextDate = addDaysUTC(start, BIWEEKLY_DAYS * idx);
  const who = (members||[]).length ? members[idx % members.length] : null;
  return { startIso, start, idx, nextDate, who };
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderAll(){
  const pot = computePot();
  const { startIso, nextDate, idx, who } = computeNext();

  // KPIs
  $("kPot").textContent = money(pot);
  $("kPotHint").textContent = members.length ? `${members.length} members • contributions reset after payout` : "Add members first";
  $("kStart").textContent = startIso ? fmtDateUTC(parseISODateUTC(startIso)) : "—";
  $("kNextDate").textContent = fmtDateUTC(nextDate);
  $("kNextWho").textContent = who ? `${who.name} • position ${idx+1}/${members.length}` : "—";

  // Payouts tab header KPIs
  $("pNextWho").textContent = who ? who.name : "—";
  $("pNextMeta").textContent = who ? `Position ${idx+1}/${members.length}` : "—";
  $("pNextDate").textContent = fmtDateUTC(nextDate);
  $("pStart").textContent = startIso ? fmtDateUTC(parseISODateUTC(startIso)) : "—";
  $("pPot").textContent = money(pot);

  // Members select
  $("mPick").innerHTML = members.map(m=>`<option value="${m.id}">${escapeHtml(m.name||"")}</option>`).join("");

  // Members table
  const mb = $("membersBody");
  mb.innerHTML = members.map(m=>{
    const last = m.last_payout_at ? new Date(m.last_payout_at).toLocaleString() : "—";
    return `<tr>
      <td class="mono">${escapeHtml(m.id)}</td>
      <td>${escapeHtml(m.name||"")}</td>
      <td class="right">${money(m.contributed)}</td>
      <td class="right">${money(m.payout_total)}</td>
      <td class="mono">${escapeHtml(last)}</td>
    </tr>`;
  }).join("");

  // Payouts table
  const pb = $("payoutBody");
  pb.innerHTML = payouts.map(p=>{
    const created = p.created_at ? new Date(p.created_at).toLocaleString() : "—";
    const pdate = p.payout_date ? fmtDateUTC(parseISODateUTC(String(p.payout_date).slice(0,10))) : "—";
    const name = p.member_name || p.name || "—";
    const mid = (p.member_id ?? "—");
    const amt = (p.amount ?? p.payout_amount ?? p.paid_amount ?? 0);
    return `<tr>
      <td class="mono">${escapeHtml(created)}</td>
      <td class="mono">${escapeHtml(pdate)}</td>
      <td>${escapeHtml(String(name))}</td>
      <td class="mono">${escapeHtml(String(mid))}</td>
      <td class="right">${money(amt)}</td>
    </tr>`;
  }).join("");
}

async function reloadAll(){
  setErr("sideErr","");
  try{
    await loadMembers();
    await loadPayouts();
    await loadAppState();  // uses payouts for normalization
    renderAll();
  }catch(e){
    setErr("sideErr", e?.message || String(e));
  }
}

/* ===========================
   PAYOUT — FIXED (NO UPDATE WITHOUT WHERE)
=========================== */
async function runPayout(){
  setErr("sideErr","");
  try{
    if(!members.length) return toast("Add members first.");
    const pot = computePot();
    if(!pot || pot <= 0) return toast("Pot is 0. Add contributions first.");

    const { startIso, start, idx, who } = computeNext();
    if(!who) return toast("No beneficiary found.");

    const payoutDate = addDaysUTC(start, BIWEEKLY_DAYS * idx);
    const payoutDateIso = isoDateUTC(payoutDate);
    const createdAt = nowIso();

    // 1) Insert payout row with member_id (fallback if schema is missing columns)
    let ins = await sb.from("payouts").insert([{
      member_id: who.id,
      member_name: who.name,
      payout_date: payoutDateIso,
      amount: pot,
      created_at: createdAt
    }]);

    if(ins.error && ins.error.message && ins.error.message.toLowerCase().includes("does not exist")){
      // fallback: try with only safe columns
      ins = await sb.from("payouts").insert([{
        member_name: who.name,
        amount: pot,
        created_at: createdAt
      }]);
    }
    if(ins.error) throw new Error("payouts insert: " + ins.error.message);

    // 2) Update beneficiary totals (must include WHERE)
    const oldTotal = Number(who.payout_total||0);
    const upBen = await sb.from("members").update({
      payout_total: oldTotal + pot,
      last_payout_at: createdAt
    }).eq("id", who.id);

    // If payout_total column doesn't exist, don't fail the whole payout
    if(upBen.error && !String(upBen.error.message||"").toLowerCase().includes("does not exist")){
      throw new Error("beneficiary update: " + upBen.error.message);
    }

    // 3) Reset contributions for ALL members (Supabase requires WHERE)
    const reset = await sb.from("members").update({ contributed: 0 }).gt("id", 0);
    if(reset.error) throw new Error("reset contributions: " + reset.error.message);

    // 4) Advance next index/date (must include WHERE)
    const nextIdx = (idx + 1) % members.length;
    const nextDate = addDaysUTC(start, BIWEEKLY_DAYS * nextIdx);
    const nextDateIso = isoDateUTC(nextDate);

    const upState = await sb.from("app_state").update({
      rotation_start_date: startIso,
      next_payout_index: nextIdx,
      next_payout_date: nextDateIso,
      updated_at: createdAt
    }).eq("id", 1);

    if(upState.error) throw new Error("app_state update: " + upState.error.message);

    toast(`Paid ${money(pot)} to ${who.name}`);
    await reloadAll();
  }catch(e){
    setErr("sideErr", e?.message || String(e));
  }
}

/* ===========================
   MEMBERS: ADD MEMBER + ADD CONTRIBUTION
=========================== */
async function addMember(){
  setErr("sideErr","");
  try{
    const name = $("mNewName").value.trim();
    if(!name) return toast("Enter a name");
    const r = await sb.from("members").insert([{ name, contributed: 0, payout_total: 0 }]);
    if(r.error) throw new Error(r.error.message);
    $("mNewName").value="";
    await reloadAll();
    toast("Member added");
  }catch(e){
    setErr("sideErr", e?.message || String(e));
  }
}
async function addContribution(){
  setErr("sideErr","");
  try{
    const id = $("mPick").value;
    const amt = Number($("mAddAmt").value||0);
    if(!id) return toast("Pick a member");
    if(!amt || amt<=0) return toast("Enter an amount > 0");

    const m = members.find(x=>String(x.id)===String(id));
    if(!m) return toast("Member not found");

    const r = await sb.from("members")
      .update({ contributed: (Number(m.contributed)||0) + amt })
      .eq("id", id);

    if(r.error) throw new Error(r.error.message);
    $("mAddAmt").value="";
    await reloadAll();
    toast("Contribution added");
  }catch(e){
    setErr("sideErr", e?.message || String(e));
  }
}

/* ===========================
   RESET START (UI button)
=========================== */
async function resetStart(){
  setErr("sideErr","");
  try{
    const createdAt = nowIso();
    const r = await sb.from("app_state").update({
      rotation_start_date: DEFAULT_ROTATION_START_ISO,
      next_payout_index: 0,
      next_payout_date: DEFAULT_ROTATION_START_ISO,
      updated_at: createdAt
    }).eq("id", 1);
    if(r.error) throw new Error(r.error.message);
    toast("Reset rotation to Jan 3, 2026");
    await reloadAll();
  }catch(e){
    setErr("sideErr", e?.message || String(e));
  }
}

/* ===========================
   UI WIRING
=========================== */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  $("tab-dash").style.display = name==="dash" ? "block" : "none";
  $("tab-members").style.display = name==="members" ? "block" : "none";
  $("tab-payouts").style.display = name==="payouts" ? "block" : "none";
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});

$("btnReload").addEventListener("click", reloadAll);
$("btnRunPayout").addEventListener("click", runPayout);
$("btnRunPayout2").addEventListener("click", runPayout);
$("btnResetStart").addEventListener("click", resetStart);

$("btnAddMember").addEventListener("click", addMember);
$("btnAddContrib").addEventListener("click", addContribution);

$("btnLogout").addEventListener("click", async ()=>{
  await sb.auth.signOut();
  location.reload();
});

/* Login */
$("btnLogin").addEventListener("click", async ()=>{
  setErr("authErr","");
  try{
    const email = $("email").value.trim();
    const password = $("password").value;
    const r = await sb.auth.signInWithPassword({ email, password });
    if(r.error) throw new Error(r.error.message);
    const ok = await enforceAdminGate();
    if(ok) await reloadAll();
  }catch(e){
    setErr("authErr", e?.message || String(e));
  }
});

/* Magic link */
$("btnMagic").addEventListener("click", async ()=>{
  setErr("authErr","");
  try{
    const email = $("email").value.trim();
    if(!email) return setErr("authErr","Enter email first.");
    const r = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: window.location.href }
    });
    if(r.error) throw new Error(r.error.message);
    toast("Magic link sent. Check your email.");
  }catch(e){
    setErr("authErr", e?.message || String(e));
  }
});

/* ===========================
   INIT
=========================== */
(async function init(){
  const ok = await enforceAdminGate();
  if(ok){
    setTab("dash");
    await reloadAll();
  }else{
    setTab("dash");
  }
})();
</script>
</body>
</html>
