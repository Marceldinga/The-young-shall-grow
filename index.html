<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Young Shall Grow ‚Äì Njangi Dashboard</title>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0f1a33;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --accent:#38bdf8;
      --accent2:#818cf8;
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --r:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(125,211,252,.20), transparent 55%),
        radial-gradient(1000px 700px at 95% 20%, rgba(129,140,248,.18), transparent 55%),
        radial-gradient(900px 700px at 20% 95%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      min-height:100vh;
    }
    a{ color:var(--accent); }
    .wrap{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:18px;
      padding:18px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .side{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:sticky;
      top:18px;
      height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;
    }
    .brand{
      padding:18px 16px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .brand .pill{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      background: rgba(56,189,248,.18);
      border:1px solid rgba(56,189,248,.35);
      color: var(--text);
    }
    .side .section{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .lbl{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, button, textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height:86px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(234,240,255,.45); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{
      cursor:pointer;
      font-weight:600;
      border:1px solid rgba(56,189,248,.35);
      background: linear-gradient(180deg, rgba(56,189,248,.26), rgba(56,189,248,.12));
    }
    .btn:hover{ filter:brightness(1.1); }
    .btn2{
      cursor:pointer;
      font-weight:600;
      border:1px solid rgba(129,140,248,.35);
      background: linear-gradient(180deg, rgba(129,140,248,.26), rgba(129,140,248,.12));
    }
    .btnDanger{
      cursor:pointer;
      font-weight:700;
      border:1px solid rgba(239,68,68,.35);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.10));
    }
    .small{ font-size:12px; color:var(--muted2); }
    .nav{
      padding:10px;
      display:grid;
      gap:8px;
    }
    .nav button{
      width:100%;
      text-align:left;
      border-radius:14px;
      padding:11px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      font-weight:600;
    }
    .nav button.active{
      border-color: rgba(56,189,248,.45);
      background: rgba(56,189,248,.12);
      box-shadow: 0 10px 30px rgba(56,189,248,.12);
    }
    .side .footer{
      margin-top:auto;
      padding:12px 16px;
      border-top:1px solid rgba(255,255,255,.06);
      color: var(--muted2);
      font-size:12px;
    }
    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topbar h2{ margin:0; font-size:16px; }
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:9999;
    }
    .content{
      padding:18px;
    }
    .grid{
      display:grid;
      gap:14px;
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:14px;
    }
    .card{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding:14px 14px 12px;
    }
    .card h3{ margin:0 0 8px; font-size:13px; color:var(--muted); font-weight:700; letter-spacing:.2px; }
    .big{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .sub{
      font-size:12px;
      color:var(--muted2);
      margin-top:6px;
    }
    .two{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    .tableWrap{
      overflow:auto;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 850px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13px;
      white-space:nowrap;
    }
    th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      background: rgba(0,0,0,.18);
      position:sticky;
      top:0;
      z-index:2;
    }
    tr:hover td{ background: rgba(56,189,248,.06); }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .tag.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .tag.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .tag.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .hidden{ display:none; }
    @media(max-width:1050px){
      .wrap{ grid-template-columns:1fr; }
      .side{ position:relative; height:auto; }
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .two{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<div class="wrap">
  <!-- SIDEBAR -->
  <aside class="side">
    <div class="brand">
      <h1>ü™ô The Young Shall Grow <span class="pill">Njangi</span></h1>
      <div class="small" style="margin-top:6px;">Admin dashboard ‚Ä¢ Supabase</div>
    </div>

    <div class="section">
      <div class="lbl">Supabase URL</div>
      <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
      <div style="height:10px"></div>
      <div class="lbl">Supabase Anon Key</div>
      <textarea id="sbKey" placeholder="paste anon key here"></textarea>
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn" onclick="connectSupabase()">Connect</button>
        <button class="btn2" onclick="logout()">Logout</button>
      </div>
      <div class="small" style="margin-top:8px;">
        Uses email/password login. Ensure RLS policies allow your admin user.
      </div>
    </div>

    <div class="section">
      <div class="lbl">Admin Login</div>
      <input id="email" placeholder="Email" />
      <div style="height:10px"></div>
      <input id="password" placeholder="Password" type="password" />
      <div style="height:10px"></div>
      <button class="btn" onclick="login()">Login</button>
      <div class="small" style="margin-top:8px;">Status: <span id="authStatus">Not connected</span></div>
      <div id="sideErr" class="small" style="margin-top:10px;color:#ffb4b4;"></div>
    </div>

    <div class="nav">
      <button id="tabBtnDashboard" class="active" onclick="switchTab('dashboard')">üìä Dashboard</button>
      <button id="tabBtnMembers" onclick="switchTab('members')">üë• Members</button>
      <button id="tabBtnContrib" onclick="switchTab('contrib')">üí∞ Contributions</button>
      <button id="tabBtnPayout" onclick="switchTab('payout')">üèÜ Payout</button>
      <button id="tabBtnLoans" onclick="switchTab('loans')">üè¶ Loans</button>
      <button id="tabBtnFines" onclick="switchTab('fines')">‚ö†Ô∏è Fines</button>
      <button id="tabBtnFoundation" onclick="switchTab('foundation')">üèõÔ∏è Foundation</button>
      <button id="tabBtnSurety" onclick="switchTab('surety')">üßæ Surety</button>
      <button id="tabBtnHistory" onclick="switchTab('history')">üïí History</button>
    </div>

    <div class="footer">
      <div>Rotation starts: <b>Jan 3, 2026</b> ‚Ä¢ Bi-weekly</div>
      <div class="small">Foundation KPI source: <b>SUM(Foundation_payments.amount_paid)</b></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <h2 id="tabTitle">üìä Dashboard</h2>
      <div class="small">Last refresh: <span id="lastRefresh">‚Äî</span></div>
    </div>

    <div class="content">
      <!-- DASHBOARD TAB -->
      <section id="tab_dashboard" class="grid">
        <div class="kpis">
          <div class="card">
            <h3>Jangi Pot</h3>
            <div class="big" id="kPot">$0</div>
            <div class="sub">Sum of members.contributed</div>
          </div>
          <div class="card">
            <h3>Foundation</h3>
            <div class="big" id="kFoundation">$0</div>
            <div class="sub">From Foundation_payments.amount_paid</div>
          </div>
          <div class="card">
            <h3>Loans Due</h3>
            <div class="big" id="kLoans">$0</div>
            <div class="sub">Sum of members.loan_due</div>
          </div>
          <div class="card">
            <h3>Members</h3>
            <div class="big" id="kMembers">0</div>
            <div class="sub">Active members</div>
          </div>
          <div class="card">
            <h3>Interest Generated</h3>
            <div class="big" id="kInterestMini">$0</div>
            <div class="sub">From app_state.total_interest_generated</div>
          </div>
        </div>

        <div class="two">
          <div class="card">
            <h3>Next Payout</h3>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div>
                <div class="big" id="nextName">‚Äî</div>
                <div class="sub" id="nextInfo">‚Äî</div>
              </div>
              <button class="btn" style="max-width:160px" onclick="reloadAll()">Refresh</button>
            </div>
            <div style="height:12px"></div>
            <canvas id="pieChart" height="110"></canvas>
          </div>

          <div class="card">
            <h3>Top Contributions (this cycle)</h3>
            <canvas id="histChart" height="210"></canvas>
          </div>
        </div>
      </section>

      <!-- MEMBERS TAB -->
      <section id="tab_members" class="grid hidden">
        <div class="card">
          <h3>Add Member</h3>
          <div class="row">
            <input id="mName" placeholder="Name" />
            <input id="mPhone" placeholder="Phone (optional)" />
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <select id="mBenefits">
              <option value="false">Has benefits? No</option>
              <option value="true">Has benefits? Yes</option>
            </select>
            <input id="mPosition" placeholder="Position (rotation order)" type="number" />
          </div>
          <div style="height:10px"></div>
          <button class="btn" onclick="addMember()">Save Member</button>
          <div class="small" style="margin-top:8px;">Tip: Position controls payout order (1 = first).</div>
        </div>

        <div class="card">
          <h3>Members List</h3>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th><th>Name</th><th>Phone</th><th>Benefits</th><th>Position</th>
                  <th>Contributed</th><th>Foundation Contrib</th><th>Loan Due</th><th>Payout Total</th><th>Last Payout</th>
                </tr>
              </thead>
              <tbody id="membersBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CONTRIBUTIONS TAB -->
      <section id="tab_contrib" class="grid hidden">
        <div class="card">
          <h3>Add Contribution</h3>
          <div class="row">
            <select id="cMember"></select>
            <input id="cAmount" placeholder="Amount" type="number" />
          </div>
          <div style="height:10px"></div>
          <button class="btn" onclick="addContribution()">Save Contribution</button>
          <div class="small" style="margin-top:8px;">This increases the Jangi Pot for the next payout.</div>
        </div>
      </section>

      <!-- PAYOUT TAB -->
      <section id="tab_payout" class="grid hidden">
        <div class="card">
          <h3>Run Payout</h3>
          <div class="small">Pays the full pot to the next member in rotation and resets contributed to 0 for all members.</div>
          <div style="height:10px"></div>
          <button class="btn" onclick="runPayout()">Run Payout Now</button>
          <div class="small" style="margin-top:8px;">If you see 0 rows updating, check RLS policies.</div>
        </div>

        <div class="card">
          <h3>Payouts</h3>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th><th>Member</th><th>Amount</th><th>Notes</th>
                </tr>
              </thead>
              <tbody id="payoutsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- LOANS TAB -->
      <section id="tab_loans" class="grid hidden">
        <div class="card">
          <h3>Issue Loan (5% interest)</h3>
          <div class="row">
            <select id="lMember"></select>
            <input id="lAmount" placeholder="Loan Amount" type="number" />
          </div>
          <div style="height:10px"></div>
          <button class="btn" onclick="issueLoan()">Issue Loan</button>
          <div class="small" style="margin-top:8px;">Loan eligibility: if member has benefits, foundation_contrib must be ‚â• 70% of loan.</div>
        </div>

        <div class="card">
          <h3>Repay Loan</h3>
          <div class="row">
            <select id="rMember"></select>
            <input id="rAmount" placeholder="Repay Amount" type="number" />
          </div>
          <div style="height:10px"></div>
          <button class="btn2" onclick="repayLoan()">Save Repayment</button>
          <div class="small" style="margin-top:8px;">Repayment adds to Foundation (ledger entry in Foundation_payments).</div>
        </div>
      </section>

      <!-- FINES TAB -->
      <section id="tab_fines" class="grid hidden">
        <div class="card">
          <h3>Add Fine</h3>
          <div class="row">
            <select id="fineMember"></select>
            <input id="fineAmount" placeholder="Fine Amount" type="number" />
          </div>
          <div style="height:10px"></div>
          <label class="lbl">Reason</label>
          <input id="fineReason" placeholder="Late payment..." />
          <div style="height:10px"></div>
          <button class="btn" onclick="addFine()">Save Fine</button>
        </div>

        <div class="card">
          <h3>Fines</h3>
          <div class="tableWrap">
            <table>
              <thead>
                <tr><th>Date</th><th>Member</th><th>Amount</th><th>Reason</th></tr>
              </thead>
              <tbody id="finesBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- FOUNDATION TAB -->
      <section id="tab_foundation" class="grid hidden">
        <div class="card">
          <h3>Admin Foundation Controls</h3>
          <div class="row">
            <input id="fAmount" placeholder="Add amount to foundation" type="number" />
            <button class="btn" onclick="addToFoundation()">Add</button>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <input id="fSetAmount" placeholder="Set foundation total (adjustment ledger)" type="number" />
            <button class="btn2" onclick="setFoundation()">Set</button>
          </div>
          <div class="small" style="margin-top:8px;">
            Foundation is computed as <b>SUM(Foundation_payments.amount_paid)</b>. Admin Set writes an adjustment row.
          </div>
        </div>

        <div class="card">
          <h3>Member Foundation Contribution</h3>
          <div class="row">
            <select id="mfMember"></select>
            <input id="mfAmount" placeholder="Amount" type="number" />
          </div>
          <div style="height:10px"></div>
          <button class="btn" onclick="addMemberFoundation()">Save</button>
          <div class="small" style="margin-top:8px;">
            Updates members.foundation_contrib AND inserts into Foundation_payments so the KPI updates.
          </div>
        </div>

        <div class="card">
          <h3>Foundation Payments</h3>
          <div class="row">
            <select id="fpMember"></select>
            <input id="fpPaid" placeholder="amount_paid" type="number" />
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <input id="fpPending" placeholder="amount_pending" type="number" />
            <input id="fpStatus" placeholder="status (optional)" />
          </div>
          <div style="height:10px"></div>
          <input id="fpNotes" placeholder="notes (optional)" />
          <div style="height:10px"></div>
          <button class="btn" onclick="addFoundationPayment()">Save Payment</button>

          <div style="height:14px"></div>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th><th>Member</th><th>Paid</th><th>Pending</th><th>Status</th><th>Notes</th>
                </tr>
              </thead>
              <tbody id="foundationBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- SURETY TAB -->
      <section id="tab_surety" class="grid hidden">
        <div class="card">
          <h3>Surety (Loan Guarantee)</h3>
          <div class="row">
            <input id="suretyName" placeholder="Surety Name" />
            <select id="borrowerMember"></select>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <input id="borrowedAmount" placeholder="Amount Borrowed" type="number" />
            <input id="suretyStatus" placeholder="status (e.g., active/closed)" />
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <input id="suretySign" placeholder="Surety Sign" />
            <input id="borrowerSign" placeholder="Borrower Sign" />
          </div>
          <div style="height:10px"></div>
          <button class="btn" onclick="addSurety()">Save Surety</button>
        </div>

        <div class="card">
          <h3>Sureties</h3>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th><th>Surety</th><th>Borrower</th><th>Amount</th><th>Status</th><th>Surety Sign</th><th>Borrower Sign</th>
                </tr>
              </thead>
              <tbody id="suretyBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- HISTORY TAB -->
      <section id="tab_history" class="grid hidden">
        <div class="card">
          <h3>History</h3>
          <div class="tableWrap">
            <table>
              <thead>
                <tr><th>Date</th><th>Type</th><th>Member</th><th>Amount</th><th>Interest %</th><th>Total Due</th></tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===========================
   CONFIG
=========================== */
const ROTATION_START = new Date("2026-01-03T00:00:00");
const BIWEEK_MS = 14 * 24 * 60 * 60 * 1000;
const INTEREST_RATE = 0.05;

/* ===========================
   STATE
=========================== */
let appState = { foundation:0, total_interest_generated:0, next_payout_index:0, next_payout_date:"2026-01-03" };

let FOUNDATION_TABLE = "foundation_payments"; // auto-detects Foundation_payments if needed
let foundationBalance = 0; // SUM(Foundation_payments.amount_paid)

let members = [];
let history = [];
let payouts = [];
let fines = [];
let foundationPayments = [];
let sureties = [];
let histChart = null;
let pieChart = null;

let sb = null;

/* ===========================
   HELPERS
=========================== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display="none", 3400);
}
function sideErr(msg){
  document.getElementById("sideErr").textContent = msg || "";
}
function appendErr(msg){
  const el = document.getElementById("sideErr");
  const cur = el.textContent || "";
  el.textContent = cur ? (cur + "\n" + msg) : msg;
}
function money(n){
  const v = Number(n||0);
  return v.toLocaleString(undefined,{style:"currency",currency:"USD"});
}
function isoDate(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x.toISOString().slice(0,10);
}
function fromIso(s){
  // supports date-only or full ISO
  if(!s) return new Date();
  if(String(s).length===10) return new Date(s+"T00:00:00");
  return new Date(s);
}

/* ===========================
   FOUNDATION SOURCE (Foundation_payments)
=========================== */
async function detectFoundationTable(){
  // Try lower-case first, then quoted mixed-case table name
  const candidates = ["foundation_payments", "Foundation_payments"];
  for(const t of candidates){
    const test = await sb.from(t).select("amount_paid").limit(1);
    if(!test.error){
      FOUNDATION_TABLE = t;
      return;
    }
    const msg = String(test.error.message || "").toLowerCase();
    if(msg.includes("does not exist")) continue; // try next
    // other errors (RLS, permissions) -> stop to avoid noisy loops
    appendErr(`${t}: ${test.error.message}`);
    return;
  }
}

async function insertFoundationLedgerRow({ memberId=null, amountPaid=0, amountPending=0, status="paid", notes=null }){
  // Prefer null member_id for admin adjustments, but fallback to first member if member_id is required
  let payload = {
    member_id: (memberId===null || memberId===undefined) ? null : Number(memberId),
    amount_paid: Number(amountPaid || 0),
    amount_pending: Number(amountPending || 0),
    status: status || null,
    notes: notes || null,
    date_paid: new Date().toISOString()
  };

  let r = await sb.from(FOUNDATION_TABLE).insert([payload]);
  if(!r.error) return r;

  const msg = String(r.error.message || "").toLowerCase();
  if(msg.includes("null value") && msg.includes("member_id") && members.length){
    payload.member_id = Number(members[0].id);
    payload.notes = (notes ? notes + " | " : "") + "Admin adjustment (member_id required)";
    r = await sb.from(FOUNDATION_TABLE).insert([payload]);
  }
  return r;
}

async function computeFoundationBalance(){
  foundationBalance = (foundationPayments || []).reduce((s,r)=> s + (Number(r.amount_paid)||0), 0);
  return foundationBalance;
}

/* ===========================
   AUTO: after 15 days from sessions.start_date -> convert pending to loans
=========================== */
async function autoConvertPendingToLoansIfDue(){
  // If sessions table doesn't exist, just skip silently (but show non-'does not exist' errors)
  const s = await sb.from("sessions").select("start_date").order("start_date",{ascending:false}).limit(1).maybeSingle();
  if(s.error){
    const msg = String(s.error.message||"").toLowerCase();
    if(!msg.includes("does not exist")){
      appendErr("sessions: " + s.error.message);
    }
    return false;
  }
  if(!s.data?.start_date) return false;

  const start = fromIso(String(s.data.start_date));
  const dueAt = new Date(start.getTime() + (15 * 24 * 60 * 60 * 1000));
  const today = fromIso(isoDate(new Date()));

  if(today < dueAt) return false;

  // Sum pending per member
  const pendingByMember = new Map();
  for(const row of (foundationPayments || [])){
    const mid = row.member_id;
    const pending = Number(row.amount_pending || 0);
    if(mid != null && pending > 0){
      pendingByMember.set(String(mid), (pendingByMember.get(String(mid))||0) + pending);
    }
  }
  if(pendingByMember.size === 0) return false;

  let changed = false;

  for(const [mid, principalRaw] of pendingByMember.entries()){
    const principal = Number(principalRaw||0);
    if(principal <= 0) continue;

    const member = members.find(m => String(m.id) === String(mid));
    const memberName = member?.name || `Member ${mid}`;

    // Insert into loans table (member_id + principal)
    const insLoan = await sb.from("loans").insert([{ member_id: Number(mid), principal }]);
    if(insLoan.error){
      appendErr("loans.insert (auto): " + insLoan.error.message);
      continue;
    }

    // Apply 5% interest and add to member loan_due
    const interest = Math.round(principal * INTEREST_RATE);
    const totalDue = principal + interest;

    const uMem = await sb.from("members")
      .update({ loan_due: (Number(member?.loan_due)||0) + totalDue })
      .eq("id", mid);

    if(uMem.error){
      appendErr("members.update (auto loan): " + uMem.error.message);
      continue;
    }

    // Track interest generated (app_state)
    const uSt = await sb.from("app_state")
      .update({
        total_interest_generated: (Number(appState.total_interest_generated)||0) + interest,
        updated_at: new Date().toISOString()
      })
      .eq("id", 1);

    if(uSt.error){
      appendErr("app_state.update (interest): " + uSt.error.message);
      // keep going (loan is created anyway)
    }

    // Mark pending as loan + clear pending
    const uFp = await sb.from(FOUNDATION_TABLE)
      .update({
        amount_pending: 0,
        status: "loan",
        notes: `Auto-converted pending to loan on ${new Date().toLocaleDateString()}`
      })
      .eq("member_id", mid)
      .gt("amount_pending", 0);

    if(uFp.error){
      appendErr("foundation_payments.update (auto loan): " + uFp.error.message);
    }

    await addHistoryRow("Auto Loan (Pending)", memberName, principal, 5, totalDue);
    changed = true;
  }

  return changed;
}

/* ===========================
   LOAD
=========================== */
function switchTab(name){
  const tabs = ["dashboard","members","contrib","payout","loans","fines","foundation","surety","history"];
  for(const t of tabs){
    document.getElementById("tab_"+t).classList.add("hidden");
    document.getElementById("tabBtn"+cap(t)).classList.remove("active");
  }
  document.getElementById("tab_"+name).classList.remove("hidden");
  document.getElementById("tabBtn"+cap(name)).classList.add("active");

  document.getElementById("tabTitle").textContent = tabTitle(name);
}
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function tabTitle(name){
  const map = {
    dashboard:"üìä Dashboard",
    members:"üë• Members",
    contrib:"üí∞ Contributions",
    payout:"üèÜ Payout",
    loans:"üè¶ Loans",
    fines:"‚ö†Ô∏è Fines",
    foundation:"üèõÔ∏è Foundation",
    surety:"üßæ Surety",
    history:"üïí History"
  };
  return map[name] || name;
}

function connectSupabase(){
  const url = document.getElementById("sbUrl").value.trim();
  const key = document.getElementById("sbKey").value.trim();
  if(!url || !key) return toast("Enter URL and anon key");
  sb = supabase.createClient(url, key);
  localStorage.setItem("nj_sbUrl", url);
  localStorage.setItem("nj_sbKey", key);
  document.getElementById("authStatus").textContent = "Supabase ready (login needed)";
  toast("Supabase client created");
}

async function login(){
  sideErr("");
  if(!sb) return toast("Connect Supabase first");
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if(!email || !password) return toast("Enter email and password");

  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) return toast(error.message);

  document.getElementById("authStatus").textContent = "Logged in";
  toast("Logged in");
  await reloadAll();
}

async function logout(){
  sideErr("");
  if(!sb) return;
  await sb.auth.signOut();
  document.getElementById("authStatus").textContent = "Logged out";
  toast("Logged out");
}

async function reloadAll(){
  sideErr("");

  // Detect correct foundation table name once
  if(!reloadAll._foundationDetected){
    reloadAll._foundationDetected = true;
    await detectFoundationTable();
  }

  // FIX: maybe missing app_state row
  const a = await sb.from("app_state").select("*").eq("id",1).maybeSingle();
  if (a.error){
    appendErr("app_state select: " + a.error.message);
  } else if (!a.data) {
    const seed = {
      id: 1,
      foundation: 0,
      next_payout_index: 0,
      next_payout_date: "2026-01-03",
      total_interest_generated: 0,
      updated_at: new Date().toISOString()
    };
    const ins = await sb.from("app_state").insert([seed]);
    if (ins.error){
      appendErr("app_state init: " + ins.error.message);
      appState = { foundation:0, total_interest_generated:0, next_payout_index:0, next_payout_date:"2026-01-03" };
    } else {
      appState = seed;
    }
  } else {
    appState = a.data;
  }

  const m = await sb.from("members").select("*").order("position", { ascending: true });
  if (m.error) appendErr("members: " + m.error.message);
  members = m.data || [];

  const h = await sb.from("history").select("*").order("created_at", { ascending: false }).limit(500);
  if (h.error) appendErr("history: " + h.error.message);
  history = h.data || [];

  const p = await sb.from("payouts").select("*").order("created_at", { ascending: false }).limit(200);
  if (p.error) appendErr("payouts: " + p.error.message);
  payouts = p.data || [];

  const f = await sb.from("fines").select("*").order("created_at", { ascending: false }).limit(200);
  if (f.error) appendErr("fines: " + f.error.message);
  fines = f.data || [];

  // NEW TABLES (won't break if not created; errors show in sidebar)
  const fp = await sb.from(FOUNDATION_TABLE).select("*").order("date_paid", { ascending: false }).limit(300);
  if (fp.error) appendErr(`${FOUNDATION_TABLE}: ` + fp.error.message);
  foundationPayments = fp.data || [];
  await computeFoundationBalance();

  // Auto: convert pending to loans after 15 days from sessions.start_date
  const autoChanged = await autoConvertPendingToLoansIfDue();
  if(autoChanged){
    // reload members, history, and foundation payments after conversion
    const m2 = await sb.from("members").select("*").order("position", { ascending: true });
    if(!m2.error) members = m2.data || members;

    const h2 = await sb.from("history").select("*").order("created_at", { ascending: false }).limit(500);
    if(!h2.error) history = h2.data || history;

    const fp2 = await sb.from(FOUNDATION_TABLE).select("*").order("date_paid", { ascending: false }).limit(300);
    if(!fp2.error) foundationPayments = fp2.data || foundationPayments;
    await computeFoundationBalance();

    const a2 = await sb.from("app_state").select("*").eq("id",1).maybeSingle();
    if(!a2.error && a2.data) appState = a2.data;
  }

  const s = await sb.from("sureties").select("*").order("date_borrowed", { ascending: false }).limit(300);
  if (s.error) appendErr("sureties: " + s.error.message);
  sureties = s.data || [];

  renderAll();

  if(members.length===0 && history.length===0 && payouts.length===0 && fines.length===0){
    appendErr("Note: If you EXPECT data but see 0 rows, RLS policies may be blocking SELECT for this user.");
  }
}

/* ===========================
   RENDER
=========================== */
function renderAll(){
  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  const outstanding = members.reduce((s,x)=>s+(Number(x.loan_due)||0),0);

  document.getElementById("kPot").textContent = money(pot);
  document.getElementById("kFoundation").textContent = money(foundationBalance||0);
  document.getElementById("kLoans").textContent = money(outstanding);
  document.getElementById("kMembers").textContent = String(members.length);
  document.getElementById("kInterestMini").textContent = money(appState.total_interest_generated||0);

  const idx = Number(appState.next_payout_index||0);
  const nextDate = appState.next_payout_date ? fromIso(appState.next_payout_date) : ROTATION_START;
  const nextMember = members.length ? members[idx % members.length] : null;

  document.getElementById("nextName").textContent = nextMember ? nextMember.name : "No members";
  document.getElementById("nextInfo").textContent = members.length
    ? `Next payout: ${nextDate.toLocaleDateString()} ‚Ä¢ Position ${(idx%members.length)+1}/${members.length} ‚Ä¢ Payout: ${money(pot)}`
    : "Add members to start rotation";

  document.getElementById("memberCount").textContent = String(members.length);

  // dropdowns
  const memberOptions = members.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
  for(const id of ["cMember","lMember","rMember","fineMember","mfMember","fpMember","borrowerMember"]){
    const el = document.getElementById(id);
    if(el) el.innerHTML = `<option value="">Select</option>${memberOptions}`;
  }

  // members table
  document.getElementById("membersBody").innerHTML = members.map(m=>{
    const tag = m.has_benefits ? `<span class="tag good">Yes</span>` : `<span class="tag warn">No</span>`;
    return `<tr>
      <td>${m.id}</td>
      <td>${m.name||""}</td>
      <td>${m.phone||""}</td>
      <td>${tag}</td>
      <td>${m.position||""}</td>
      <td>${money(m.contributed||0)}</td>
      <td>${money(m.foundation_contrib||0)}</td>
      <td>${money(m.loan_due||0)}</td>
      <td>${money(m.payout_total||0)}</td>
      <td>${m.last_payout_at? new Date(m.last_payout_at).toLocaleString() : ""}</td>
    </tr>`;
  }).join("");

  // payouts table
  document.getElementById("payoutsBody").innerHTML = payouts.map(p=>{
    const dt = p.created_at ? new Date(p.created_at).toLocaleString() : "";
    return `<tr>
      <td>${dt}</td>
      <td>${p.member_name||p.member||""}</td>
      <td>${money(p.amount||0)}</td>
      <td>${p.notes||""}</td>
    </tr>`;
  }).join("");

  // fines table
  document.getElementById("finesBody").innerHTML = fines.map(p=>{
    const dt = p.created_at ? new Date(p.created_at).toLocaleString() : "";
    return `<tr>
      <td>${dt}</td>
      <td>${p.member_name||p.member||""}</td>
      <td>${money(p.amount||0)}</td>
      <td>${p.reason||""}</td>
    </tr>`;
  }).join("");

  // foundation payments table
  const membersById = Object.fromEntries(members.map(m=>[String(m.id), m]));
  document.getElementById("foundationBody").innerHTML = foundationPayments.map(r=>{
    const t = r.date_paid ? new Date(r.date_paid).toLocaleString() : (r.created_at ? new Date(r.created_at).toLocaleString() : "");
    const name = r.member_name || (membersById[String(r.member_id)]?.name) || "";
    return `<tr>
      <td>${t}</td>
      <td>${name}</td>
      <td>${money(r.amount_paid||0)}</td>
      <td>${money(r.amount_pending||0)}</td>
      <td>${r.status||""}</td>
      <td>${r.notes||""}</td>
    </tr>`;
  }).join("");

  // history table
  document.getElementById("historyBody").innerHTML = history.map(h=>{
    const dt = h.created_at ? new Date(h.created_at).toLocaleString() : "";
    return `<tr>
      <td>${dt}</td>
      <td>${h.type||""}</td>
      <td>${h.member||""}</td>
      <td>${money(h.amount||0)}</td>
      <td>${h.interest_percent||0}</td>
      <td>${h.total_due==null? "" : money(h.total_due)}</td>
    </tr>`;
  }).join("");

  // surety table
  document.getElementById("suretyBody").innerHTML = sureties.map(r=>{
    const t = r.date_borrowed ? new Date(r.date_borrowed).toLocaleString() : (r.created_at ? new Date(r.created_at).toLocaleString() : "");
    const borrower = r.borrower_name || (membersById[String(r.borrower_member_id)]?.name) || "";
    return `<tr>
      <td>${t}</td>
      <td>${r.surety_name||""}</td>
      <td>${borrower}</td>
      <td>${money(r.amount_borrowed||0)}</td>
      <td>${r.status||""}</td>
      <td>${r.surety_sign||""}</td>
      <td>${r.borrower_sign||""}</td>
    </tr>`;
  }).join("");

  renderCharts();

  document.getElementById("lastRefresh").textContent = new Date().toLocaleString();
}

function renderCharts(){
  if(typeof Chart === "undefined"){
    appendErr("Chart.js not loaded. Charts disabled.");
    return;
  }

  const top = members
    .map(m => ({ name: m.name || "Member", v: Number(m.contributed || 0) }))
    .sort((a,b)=>b.v-a.v)
    .slice(0,10);

  const hctx = document.getElementById("histChart").getContext("2d");
  if(histChart) histChart.destroy();
  histChart = new Chart(hctx,{
    type:"bar",
    data:{ labels: top.map(x=>x.name), datasets:[{ label:"Contributions", data: top.map(x=>x.v) }] },
    options:{
      responsive:true,
      plugins:{ legend:{display:false} },
      scales:{
        x:{ ticks:{color:"rgba(234,240,255,.7)"}, grid:{color:"rgba(255,255,255,.06)"} },
        y:{ ticks:{color:"rgba(234,240,255,.7)"}, grid:{color:"rgba(255,255,255,.06)"} }
      }
    }
  });

  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  const loans = members.reduce((s,x)=>s+(Number(x.loan_due)||0),0);
  const foundation = Number(foundationBalance||0);

  const pctx = document.getElementById("pieChart").getContext("2d");
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pctx,{
    type:"pie",
    data:{ labels:["Pot","Foundation","Loans Due"], datasets:[{ data:[pot, foundation, loans] }] },
    options:{
      responsive:true,
      plugins:{ legend:{ position:"bottom", labels:{ color:"rgba(234,240,255,.75)" } } }
    }
  });
}

/* ===========================
   WRITES
=========================== */
async function addHistoryRow(type, member, amount, interestPercent=0, totalDue=null){
  await sb.from("history").insert([{ type, member, amount, interest_percent:interestPercent, total_due:totalDue }]);
}

/* ADD MEMBER */
async function addMember(){
  const name=document.getElementById("mName").value.trim();
  const phone=document.getElementById("mPhone").value.trim();
  const hasBenefits=document.getElementById("mBenefits").value==="true";
  const position=Number(document.getElementById("mPosition").value||0);

  if(!name) return toast("Name required");
  if(!position||position<=0) return toast("Position required");

  const r=await sb.from("members").insert([{ name, phone:phone||null, has_benefits:hasBenefits, position }]);
  if(r.error) return toast(r.error.message);

  document.getElementById("mName").value="";
  document.getElementById("mPhone").value="";
  document.getElementById("mPosition").value="";

  await reloadAll();
  toast("Member added");
}

/* ADD CONTRIBUTION */
async function addContribution(){
  const memberId=document.getElementById("cMember").value;
  const amt=Number(document.getElementById("cAmount").value||0);
  if(!memberId) return toast("Select member");
  if(!amt||amt<=0) return toast("Enter amount");

  const m=members.find(x=>String(x.id)===String(memberId));
  const newTotal=(Number(m.contributed)||0)+amt;

  let u=await sb.from("members").update({ contributed: newTotal }).eq("id", memberId);
  if (u.error) return toast(u.error.message);

  await addHistoryRow("Contribution",m.name,amt,0,newTotal);
  document.getElementById("cAmount").value="";
  await reloadAll();
  toast("Contribution saved");
}

/* PAYOUT */
async function runPayout(){
  // Try RPC
  const r = await sb.rpc("run_payout", {});
  if (!r.error){
    await reloadAll();
    toast("Payout executed (RPC)");
    return;
  }
  appendErr("run_payout RPC failed (fallback used): " + r.error.message);

  if(!members.length) return toast("No members");
  const idx = Number(appState.next_payout_index||0) % members.length;
  const receiver = members[idx];

  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  if(pot<=0) return toast("Pot is zero");

  // Insert payout
  let ins = await sb.from("payouts").insert([{ member_id: receiver.id, member_name: receiver.name, amount: pot, notes:"Bi-weekly rotation payout" }]);
  if(ins.error) return toast(ins.error.message);

  // Update receiver
  let up = await sb.from("members").update({ payout_total:(Number(receiver.payout_total)||0)+pot, last_payout_at:new Date().toISOString() }).eq("id",receiver.id);
  if(up.error) return toast(up.error.message);

  const ids = members.map(m => m.id);

  let reset = await sb.from("members").update({ contributed: 0 }).in("id", ids);
  if(reset.error){
    // Fallback: still keep a WHERE clause
    reset = await sb.from("members").update({ contributed: 0 }).gt("id", 0);
  }
  if(reset.error) return toast(reset.error.message);

  const newIdx=(idx+1)%members.length;
  const newNextDate=new Date((appState.next_payout_date? fromIso(appState.next_payout_date) : ROTATION_START).getTime()+BIWEEK_MS);

  let st = await sb.from("app_state").update({ next_payout_index:newIdx, next_payout_date:isoDate(newNextDate), updated_at:new Date().toISOString() }).eq("id",1);
  if(st.error) return toast(st.error.message);

  await addHistoryRow("Payout",receiver.name,pot,0,pot);
  await reloadAll();
  toast(`Paid ${money(pot)} to ${receiver.name}`);
}

/* FOUNDATION ADMIN */
async function addToFoundation(){
  const amt=Number(document.getElementById("fAmount").value||0);
  if(!amt||amt<=0) return toast("Enter amount");

  const r = await insertFoundationLedgerRow({
    memberId: null,
    amountPaid: amt,
    amountPending: 0,
    status: "admin_add",
    notes: "Admin add to foundation"
  });
  if(r.error) return toast(r.error.message);

  await addHistoryRow("Foundation Add","Admin",amt,0,(Number(foundationBalance)||0)+amt);
  document.getElementById("fAmount").value="";
  await reloadAll(); toast("Saved");
}

async function setFoundation(){
  const amt=Number(document.getElementById("fSetAmount").value||0);
  if(amt<0) return toast("Invalid amount");

  const current = Number(foundationBalance||0);
  const diff = amt - current;
  if(Math.abs(diff) < 1e-9) return toast("Already at that amount");

  const r = await insertFoundationLedgerRow({
    memberId: null,
    amountPaid: diff,
    amountPending: 0,
    status: "admin_set",
    notes: `Admin set foundation to ${amt} (adjustment ${diff})`
  });
  if(r.error) return toast(r.error.message);

  await addHistoryRow("Foundation Set","Admin",amt,0,amt);
  document.getElementById("fSetAmount").value="";
  await reloadAll(); toast("Updated");
}

async function addMemberFoundation(){
  const memberId=document.getElementById("mfMember").value;
  const amt=Number(document.getElementById("mfAmount").value||0);
  if(!memberId) return toast("Select member");
  if(!amt||amt<=0) return toast("Enter amount");

  const m=members.find(x=>String(x.id)===String(memberId));
  const newMemberFound=(Number(m.foundation_contrib)||0)+amt;

  let r=await sb.from("members").update({foundation_contrib:newMemberFound}).eq("id",memberId);
  if(r.error) return toast(r.error.message);

  // Record into Foundation_payments so foundationBalance updates from SUM(amount_paid)
  r = await insertFoundationLedgerRow({
    memberId,
    amountPaid: amt,
    amountPending: 0,
    status: "member_foundation",
    notes: `Member foundation contribution: ${m?.name || ""}`
  });
  if(r.error) return toast(r.error.message);

  await addHistoryRow("Member Foundation",m.name,amt,0,newMemberFound);
  document.getElementById("mfAmount").value="";
  await reloadAll(); toast("Saved");
}

/* FOUNDATION PAYMENT ROW */
async function addFoundationPayment(){
  const memberId=document.getElementById("fpMember").value || null;
  const paid=Number(document.getElementById("fpPaid").value||0);
  const pending=Number(document.getElementById("fpPending").value||0);
  const status=document.getElementById("fpStatus").value.trim() || "paid";
  const notes=document.getElementById("fpNotes").value.trim() || null;

  if(!paid && !pending) return toast("Enter paid or pending");

  const r = await insertFoundationLedgerRow({
    memberId: memberId ? Number(memberId) : null,
    amountPaid: paid,
    amountPending: pending,
    status,
    notes
  });
  if(r.error) return toast(r.error.message);

  document.getElementById("fpPaid").value="";
  document.getElementById("fpPending").value="";
  document.getElementById("fpStatus").value="";
  document.getElementById("fpNotes").value="";
  await reloadAll(); toast("Saved");
}

/* LOANS */
async function issueLoan(){
  const memberId=document.getElementById("lMember").value;
  const amt=Number(document.getElementById("lAmount").value||0);
  if(!memberId) return toast("Select member");
  if(!amt||amt<=0) return toast("Enter loan amount");

  const m=members.find(x=>String(x.id)===String(memberId));
  const foundation=Number(foundationBalance||0);
  if(amt>foundation) return toast("Loan exceeds foundation");

  const minReq=0.70*amt;
  const memberFound=Number(m.foundation_contrib||0);
  if(m.has_benefits && memberFound<=minReq) return toast("Not qualified");

  const interest=Math.round(amt*INTEREST_RATE);
  const totalDue=amt+interest;

  let r=await sb.from("members").update({loan_due:(Number(m.loan_due)||0)+totalDue}).eq("id",memberId);
  if(r.error) return toast(r.error.message);

  r=await sb.from("app_state").update({
    total_interest_generated: (Number(appState.total_interest_generated)||0) + interest,
    updated_at:new Date().toISOString()
  }).eq("id",1);
  if(r.error) return toast(r.error.message);

  // Reduce foundation using ledger (negative amount_paid)
  r = await insertFoundationLedgerRow({
    memberId,
    amountPaid: -amt,
    amountPending: 0,
    status: "loan_out",
    notes: `Loan issued to ${m?.name || ""}`
  });
  if(r.error) return toast(r.error.message);

  await addHistoryRow("Loan",m.name,amt,5,totalDue);
  document.getElementById("lAmount").value="";
  await reloadAll(); toast("Loan issued");
}

async function repayLoan(){
  const memberId=document.getElementById("rMember").value;
  const amt=Number(document.getElementById("rAmount").value||0);
  if(!memberId) return toast("Select member");
  if(!amt||amt<=0) return toast("Enter amount");

  const m=members.find(x=>String(x.id)===String(memberId));
  const due=Number(m.loan_due||0);
  if(due<=0) return toast("No loan due");

  const pay=Math.min(amt,due);
  const newDue=due-pay;

  let r=await sb.from("members").update({loan_due:newDue}).eq("id",memberId);
  if(r.error) return toast(r.error.message);

  r = await insertFoundationLedgerRow({
    memberId,
    amountPaid: pay,
    amountPending: 0,
    status: "repayment_in",
    notes: `Loan repayment from ${m?.name || ""}`
  });
  if(r.error) return toast(r.error.message);

  await addHistoryRow("Repayment",m.name,pay,0,newDue);
  document.getElementById("rAmount").value="";
  await reloadAll(); toast("Repayment saved");
}

/* FINES */
async function addFine(){
  const memberId=document.getElementById("fineMember").value;
  const amt=Number(document.getElementById("fineAmount").value||0);
  const reason=document.getElementById("fineReason").value.trim();
  if(!memberId) return toast("Select member");
  if(!amt||amt<=0) return toast("Enter amount");
  if(!reason) return toast("Enter reason");

  const m=members.find(x=>String(x.id)===String(memberId));
  const r=await sb.from("fines").insert([{ member_id: memberId, member_name: m?.name||"", amount: amt, reason }]);
  if(r.error) return toast(r.error.message);

  document.getElementById("fineAmount").value="";
  document.getElementById("fineReason").value="";
  await reloadAll(); toast("Fine saved");
}

/* SURETY */
async function addSurety(){
  const surety_name=document.getElementById("suretyName").value.trim();
  const borrower_member_id=document.getElementById("borrowerMember").value;
  const amount_borrowed=Number(document.getElementById("borrowedAmount").value||0);
  const status=document.getElementById("suretyStatus").value.trim() || "active";
  const surety_sign=document.getElementById("suretySign").value.trim() || null;
  const borrower_sign=document.getElementById("borrowerSign").value.trim() || null;

  if(!surety_name) return toast("Enter surety name");
  if(!borrower_member_id) return toast("Select borrower");
  if(!amount_borrowed||amount_borrowed<=0) return toast("Enter amount");

  const r=await sb.from("sureties").insert([{
    surety_name,
    borrower_member_id: Number(borrower_member_id),
    amount_borrowed,
    status,
    surety_sign,
    borrower_sign,
    date_borrowed: new Date().toISOString()
  }]);

  if(r.error) return toast(r.error.message);

  document.getElementById("suretyName").value="";
  document.getElementById("borrowerMember").value="";
  document.getElementById("borrowedAmount").value="";
  document.getElementById("suretyStatus").value="";
  document.getElementById("suretySign").value="";
  document.getElementById("borrowerSign").value="";
  await reloadAll(); toast("Surety saved");
}

/* ===========================
   INIT
=========================== */
(function init(){
  const url = localStorage.getItem("nj_sbUrl") || "";
  const key = localStorage.getItem("nj_sbKey") || "";
  document.getElementById("sbUrl").value = url;
  document.getElementById("sbKey").value = key;

  if(url && key){
    sb = supabase.createClient(url, key);
    document.getElementById("authStatus").textContent = "Supabase ready (login needed)";
  }
})();
</script>

</body>
</html>
