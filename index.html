<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Njangi Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel2:#0b1220;
      --border:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#60a5fa; --bad:#ef4444; --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{display:flex;min-height:100vh}
    .sidebar{width:330px;background:var(--panel);border-right:1px solid var(--border);padding:16px}
    .main{flex:1;padding:18px}
    .brand{font-weight:900;font-size:16px}
    .sub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:14px;box-shadow:0 10px 24px rgba(0,0,0,.28)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{display:inline-block;padding:4px 9px;border-radius:999px;border:1px solid var(--border);background:#111827;font-size:12px}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#111827;color:var(--text);cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:14px}
    .nav button{width:100%;text-align:left;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel2);color:var(--text);cursor:pointer}
    .nav button.active{border-color:var(--accent);box-shadow:0 0 0 1px rgba(96,165,250,.2) inset}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
    .title{font-size:18px;font-weight:900}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .val{font-size:22px;font-weight:900;margin-top:6px}
    .section{display:none}
    .section.active{display:block}
    label{display:block;color:var(--muted);font-size:12px;margin-top:10px}
    input,select{width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid var(--border);background:var(--panel2);color:var(--text);outline:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:12px;vertical-align:top}
    th{color:var(--muted);font-weight:800}
    .notice{border:1px solid var(--border);background:#0b1324;border-radius:12px;padding:10px 12px;color:var(--muted);font-size:12px}
    .err{color:#fca5a5;white-space:pre-wrap;font-size:12px;margin-top:10px;display:none}

    /* LOCK SCREEN */
    #locked{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:22px}
    .lockBox{width:min(560px,100%);background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.35)}
    .lockTitle{font-size:18px;font-weight:1000;margin:0}
    .lockSub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.5}
    .lockGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .lockGrid input{margin-top:0}
    .bad{color:var(--bad)} .warn{color:var(--warn)}

    @media (max-width:1100px){.grid4{grid-template-columns:1fr 1fr}.grid2{grid-template-columns:1fr}.sidebar{width:100%;max-width:360px}}
  </style>
</head>

<body>

<!-- LOCKED VIEW -->
<div id="locked">
  <div class="lockBox">
    <p class="lockTitle">Njangi Admin Login</p>
    <div class="lockSub">
      This dashboard is <b>admin-only</b>. Nothing is shown until you sign in and your role is verified.
      <br/>Project ref: <span class="pill">auxdvufuhdnlalupwrrb</span>
    </div>

    <div class="lockGrid">
      <input id="email" placeholder="Admin email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    </div>

    <button class="btn" style="width:100%;margin-top:10px" onclick="signIn()">Sign in</button>
    <div id="lockMsg" class="lockSub" style="margin-top:10px"></div>

    <div class="notice" style="margin-top:12px">
      If you see <b>Invalid API key</b>, your <b>anon public key</b> does not match this project ref.
      Go to Supabase → Project Settings → API → copy <b>anon public</b>.
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap" style="display:none;">
  <aside class="sidebar">
    <div class="brand">Njangi Dashboard</div>
    <div class="sub">Admin-only • <span id="today"></span></div>

    <div class="card">
      <div class="row"><span class="sub">Signed in</span><span class="pill" id="who">—</span></div>
      <div class="row" style="margin-top:10px;"><span class="sub">Role</span><span class="pill" id="role">—</span></div>
      <button class="btn" style="width:100%;margin-top:10px" onclick="signOut()">Logout</button>
      <div id="sideErr" class="err"></div>
    </div>

    <div class="nav">
      <button id="navDash" class="active" onclick="show('dash','Dashboard')">Dashboard</button>
      <button id="navMembers" onclick="show('members','Members')">Members</button>
      <button id="navContrib" onclick="show('contrib','Contributions')">Contributions</button>
      <button id="navFoundation" onclick="show('foundation','Foundation')">Foundation</button>
      <button id="navLoans" onclick="show('loans','Loans')">Loans</button>
      <button id="navFines" onclick="show('fines','Fines')">Fines</button>
      <button id="navPayouts" onclick="show('payouts','Payouts')">Payouts</button>
      <button id="navHistory" onclick="show('history','History')">History</button>
      <button class="btn" style="margin-top:6px" onclick="reloadAll()">Refresh</button>
    </div>

    <div class="card">
      <div class="sub"><b>Rotation</b></div>
      <div style="margin-top:8px;font-weight:900" id="nextName">—</div>
      <div class="sub" id="nextInfo">—</div>
      <button class="btn" style="width:100%;margin-top:10px" onclick="runPayout()">Run Payout Now</button>
      <div class="sub warn" style="margin-top:10px">Start date: <b>Jan 3, 2026</b> • Bi-weekly</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title" id="pageTitle">Dashboard</div>
      <span class="pill">Total Interest: <b id="kInterestMini">$0</b></span>
    </div>

    <!-- DASH -->
    <section id="dash" class="section active">
      <div class="grid4">
        <div class="card kpi"><div class="label">Njangi Pot</div><div class="val" id="kPot">$0</div><div class="sub">Sum of contributions</div></div>
        <div class="card kpi"><div class="label">Foundation</div><div class="val" id="kFoundation">$0</div><div class="sub">Available for loans</div></div>
        <div class="card kpi"><div class="label">Outstanding Loans</div><div class="val" id="kLoans">$0</div><div class="sub">Total due</div></div>
        <div class="card kpi"><div class="label">Members</div><div class="val" id="kMembers">0</div><div class="sub">Rotation list</div></div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="card">
          <div class="row"><div style="font-weight:900;">Pot Trend</div><span class="pill">Last 30</span></div>
          <canvas id="potChart" height="120"></canvas>
        </div>
        <div class="card">
          <div class="row"><div style="font-weight:900;">Interest Trend</div><span class="pill">Last 30</span></div>
          <canvas id="interestChart" height="120"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div style="font-weight:900;">Recent Activity</div><span class="pill">Top 15</span></div>
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Member</th><th>Amount</th><th>Interest %</th><th>Total Due</th></tr></thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>
    </section>

    <!-- MEMBERS -->
    <section id="members" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Add Member</div>
          <label>Name</label><input id="mName" placeholder="e.g. John Doe" />
          <label>Phone (optional)</label><input id="mPhone" placeholder="e.g. 301-000-0000" />
          <label>Has benefits?</label>
          <select id="mBenefits"><option value="false">No</option><option value="true">Yes</option></select>
          <button class="btn" style="width:100%;margin-top:12px" onclick="addMember()">Add Member</button>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900;">Member List</div><span class="pill">Total: <span id="memberCount">0</span></span></div>
          <table>
            <thead><tr><th>Name</th><th>Njangi</th><th>Foundation</th><th>Loan Due</th><th>Payout Total</th><th>Benefits</th></tr></thead>
            <tbody id="memberBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CONTRIBUTIONS -->
    <section id="contrib" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Add Contribution</div>
          <label>Member</label><select id="cMember"></select>
          <label>Amount (multiple of 500)</label><input id="cAmount" type="number" placeholder="e.g. 500" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="addContribution()">Save Contribution</button>
          <div class="notice" style="margin-top:12px">Rule: Contributions must be multiples of <b>500</b>.</div>
        </div>
        <div class="card">
          <div style="font-weight:900;">Set Contribution Total</div>
          <label>Member</label><select id="cSetMember"></select>
          <label>Set to amount</label><input id="cSetAmount" type="number" placeholder="e.g. 2000" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="setContribution()">Set Contribution</button>
        </div>
      </div>
    </section>

    <!-- FOUNDATION -->
    <section id="foundation" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Foundation Balance</div>
          <label>Add to Foundation</label><input id="fAmount" type="number" placeholder="e.g. 500" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="addToFoundation()">Add</button>
          <hr style="border:0;border-top:1px solid var(--border);margin:14px 0;">
          <label>Set Foundation Total</label><input id="fSetAmount" type="number" placeholder="e.g. 5000" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="setFoundation()">Set Foundation</button>
        </div>

        <div class="card">
          <div style="font-weight:900;">Member Foundation Contribution</div>
          <label>Member</label><select id="mfMember"></select>
          <label>Amount</label><input id="mfAmount" type="number" placeholder="e.g. 500" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="addMemberFoundation()">Add Member Foundation</button>
          <div class="notice" style="margin-top:12px">This increases both <b>member.foundation_contrib</b> and <b>app_state.foundation</b>.</div>
        </div>
      </div>
    </section>

    <!-- LOANS -->
    <section id="loans" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Issue Loan (5%)</div>
          <label>Member</label><select id="lMember"></select>
          <label>Loan amount</label><input id="lAmount" type="number" placeholder="e.g. 1000" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="issueLoan()">Issue Loan</button>
          <div class="notice" style="margin-top:12px">
            Rule: If <b>benefits = Yes</b> and member foundation ≤ <b>70%</b> of loan → not qualified.
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900;">Record Repayment</div>
          <label>Member</label><select id="rMember"></select>
          <label>Repayment amount</label><input id="rAmount" type="number" placeholder="e.g. 500" />
          <button class="btn" style="width:100%;margin-top:12px" onclick="repayLoan()">Save Repayment</button>
        </div>
      </div>
    </section>

    <!-- FINES -->
    <section id="fines" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Add Fine</div>
          <label>Member</label><select id="fineMember"></select>
          <label>Fine amount</label><input id="fineAmount" type="number" placeholder="e.g. 500" />
          <label>Reason</label><input id="fineReason" placeholder="Late payment..." />
          <button class="btn" style="width:100%;margin-top:12px" onclick="addFine()">Save Fine</button>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900;">Fines</div><span class="pill">Newest first</span></div>
          <table>
            <thead><tr><th>Date</th><th>Member</th><th>Amount</th><th>Reason</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="fineBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAYOUTS -->
    <section id="payouts" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Run Payout</div>
          <div class="sub" style="margin-top:6px;">
            Start: <b>Jan 3, 2026</b> • every <b>14 days</b><br/>
            Payout amount = current Njangi pot<br/>
            After payout: contributions reset to 0
          </div>
          <button class="btn" style="width:100%;margin-top:12px" onclick="runPayout()">Run Now</button>
        </div>

        <div class="card">
          <div style="font-weight:900;">Payout History</div>
          <table>
            <thead><tr><th>Date</th><th>Member</th><th>Amount</th></tr></thead>
            <tbody id="payoutBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="history" class="section">
      <div class="card">
        <div class="row"><div style="font-weight:900;">Full History</div><span class="pill">Latest first</span></div>
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Member</th><th>Amount</th><th>Interest %</th><th>Total Due</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<script>
/* ===========================
   SUPABASE CONFIG (SAFE)
=========================== */
const SUPABASE_URL = "https://auxdvufuhdnlalupwrrb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eGR2dWZ1aGRubGFsdXB3cnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjk2NzcsImV4cCI6MjA3Njc0NTY3N30.BLZ6Xl8O2_edvq5cLgksGwNZn3lByZqUlT_uYNMa7bs"; // Settings → API → anon public

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===========================
   CONSTANTS
=========================== */
const ROTATION_START = new Date("2026-01-03T00:00:00");
const BIWEEK_MS = 14 * 24 * 60 * 60 * 1000;
const INTEREST_RATE = 0.05;

/* ===========================
   STATE
=========================== */
let appState = { foundation:0, total_interest_generated:0, next_payout_index:0, next_payout_date:"2026-01-03" };
let members = [];
let history = [];
let payouts = [];
let fines = [];
let potChart = null;
let interestChart = null;

/* ===========================
   HELPERS
=========================== */
const money = (x) => "$" + (Number(x)||0).toLocaleString();
const isoDate = (d) => {
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
};
const fromIso = (s) => new Date(s + "T00:00:00");
function lockMsg(html){ document.getElementById("lockMsg").innerHTML = html || ""; }
function sideErr(msg){
  const el = document.getElementById("sideErr");
  el.style.display = msg ? "block" : "none";
  el.textContent = msg || "";
}
function show(sectionId, title){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(sectionId).classList.add("active");
  document.getElementById("pageTitle").textContent = title;
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  const map = {
    dash:"navDash", members:"navMembers", contrib:"navContrib", foundation:"navFoundation",
    loans:"navLoans", fines:"navFines", payouts:"navPayouts", history:"navHistory"
  };
  document.getElementById(map[sectionId])?.classList.add("active");
}

/* ===========================
   ADMIN GATE (NO DATA BEFORE ADMIN)
=========================== */
async function enforceAdminGate(){
  const { data } = await sb.auth.getUser();
  const user = data?.user;
  if(!user){
    document.getElementById("app").style.display="none";
    document.getElementById("locked").style.display="flex";
    lockMsg(`<span class="warn">Please sign in.</span>`);
    return false;
  }

  // Must have profiles.role = 'admin'
  const { data: profile, error } = await sb.from("profiles").select("role").eq("id", user.id).single();
  if(error){
    document.getElementById("app").style.display="none";
    document.getElementById("locked").style.display="flex";
    lockMsg(`<span class="bad">profiles/role not ready:</span> ${error.message}<br/>Run the SQL and set your role=admin.`);
    return false;
  }
  if(profile?.role !== "admin"){
    await sb.auth.signOut();
    document.getElementById("app").style.display="none";
    document.getElementById("locked").style.display="flex";
    lockMsg(`<span class="bad">Access denied.</span> Your user is not admin.`);
    return false;
  }

  // Unlock
  document.getElementById("locked").style.display="none";
  document.getElementById("app").style.display="flex";
  document.getElementById("who").textContent = user.email || "admin";
  document.getElementById("role").textContent = "admin";
  document.getElementById("today").textContent = new Date().toLocaleDateString();
  return true;
}

async function signIn(){
  lockMsg("");
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if(!email || !password){
    lockMsg(`<span class="warn">Enter email and password.</span>`);
    return;
  }
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){
    lockMsg(`<span class="bad">Login failed:</span> ${error.message}`);
    return;
  }
  const ok = await enforceAdminGate();
  if(ok) await reloadAll();
}

async function signOut(){
  await sb.auth.signOut();
  document.getElementById("app").style.display="none";
  document.getElementById("locked").style.display="flex";
  lockMsg(`<span class="warn">Signed out.</span>`);
}

/* ===========================
   LOAD ALL DATA
=========================== */
async function reloadAll(){
  sideErr("");

  const a = await sb.from("app_state").select("*").eq("id",1).single();
  if(a.error){ sideErr("app_state error: " + a.error.message); }
  else appState = a.data;

  const m = await sb.from("members").select("*").order("position",{ascending:true});
  if(m.error){ sideErr((sideErr.textContent?sideErr.textContent+"\n":"") + "members error: " + m.error.message); }
  members = m.data || [];

  const h = await sb.from("history").select("*").order("created_at",{ascending:false}).limit(500);
  if(h.error){ sideErr((sideErr.textContent?sideErr.textContent+"\n":"") + "history error: " + h.error.message); }
  history = h.data || [];

  const p = await sb.from("payouts").select("*").order("created_at",{ascending:false}).limit(200);
  if(p.error){ sideErr((sideErr.textContent?sideErr.textContent+"\n":"") + "payouts error: " + p.error.message); }
  payouts = p.data || [];

  const f = await sb.from("fines").select("*").order("created_at",{ascending:false}).limit(200);
  if(f.error){ sideErr((sideErr.textContent?sideErr.textContent+"\n":"") + "fines error: " + f.error.message); }
  fines = f.data || [];

  renderAll();
}

/* ===========================
   RENDER
=========================== */
function renderAll(){
  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  const outstanding = members.reduce((s,x)=>s+(Number(x.loan_due)||0),0);

  document.getElementById("kPot").textContent = money(pot);
  document.getElementById("kFoundation").textContent = money(appState.foundation||0);
  document.getElementById("kLoans").textContent = money(outstanding);
  document.getElementById("kMembers").textContent = String(members.length);
  document.getElementById("kInterestMini").textContent = money(appState.total_interest_generated||0);

  // Rotation info
  const idx = Number(appState.next_payout_index||0);
  const nextDate = appState.next_payout_date ? fromIso(appState.next_payout_date) : ROTATION_START;
  const nextMember = members.length ? members[idx % members.length] : null;
  document.getElementById("nextName").textContent = nextMember ? nextMember.name : "No members";
  document.getElementById("nextInfo").textContent = members.length
    ? `Next: ${nextDate.toLocaleDateString()} • Position ${(idx%members.length)+1}/${members.length} • Payout: ${money(pot)}`
    : "Add members to start rotation";

  // Members table
  document.getElementById("memberCount").textContent = String(members.length);
  document.getElementById("memberBody").innerHTML = members
    .slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .map(x=>`
      <tr>
        <td>${x.name||""}</td>
        <td>${money(x.contributed||0)}</td>
        <td>${money(x.foundation_contrib||0)}</td>
        <td>${money(x.loan_due||0)}</td>
        <td>${money(x.payout_total||0)}</td>
        <td>${x.has_benefits ? "Yes":"No"}</td>
      </tr>
    `).join("");

  // Select options
  const opts = members.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
  ["cMember","cSetMember","mfMember","lMember","rMember","fineMember"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.innerHTML=opts;
  });

  // Recent activity + history
  const recent = history.slice(0,15);
  document.getElementById("recentBody").innerHTML = recent.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    return `<tr><td>${t}</td><td>${x.type||""}</td><td>${x.member||""}</td><td>${money(x.amount||0)}</td><td>${x.interest_percent?Number(x.interest_percent)+"%":"-"}</td><td>${x.total_due!=null?money(x.total_due):"-"}</td></tr>`;
  }).join("");

  document.getElementById("historyBody").innerHTML = history.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    return `<tr><td>${t}</td><td>${x.type||""}</td><td>${x.member||""}</td><td>${money(x.amount||0)}</td><td>${x.interest_percent?Number(x.interest_percent)+"%":"-"}</td><td>${x.total_due!=null?money(x.total_due):"-"}</td></tr>`;
  }).join("");

  // Payouts
  document.getElementById("payoutBody").innerHTML = payouts.map(x=>`
    <tr><td>${x.payout_date||""}</td><td>${x.member_name||""}</td><td>${money(x.payout_amount||0)}</td></tr>
  `).join("");

  // Fines
  document.getElementById("fineBody").innerHTML = fines.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    const action = (x.status||"unpaid")==="unpaid"
      ? `<button class="btn" onclick="markFinePaid(${x.id})">Mark Paid</button>`
      : "-";
    return `<tr><td>${t}</td><td>${x.member_name||""}</td><td>${money(x.amount||0)}</td><td>${x.reason||"-"}</td><td>${x.status||"unpaid"}</td><td>${action}</td></tr>`;
  }).join("");

  renderCharts();
}

function renderCharts(){
  const last = history.slice().reverse().slice(-30);
  const labels = last.map(x => (x.created_at?new Date(x.created_at):new Date()).toLocaleDateString());

  let pot=0;
  const potSeries=[];
  let interestCum=0;
  const intSeries=[];

  last.forEach(ev=>{
    const type=(ev.type||"").toLowerCase();
    const amt=Number(ev.amount||0);

    if(type.includes("contribution")) pot += amt;
    if(type.includes("set contribution")) pot = amt;
    if(type.includes("payout")) pot = 0;
    potSeries.push(pot);

    if(type.includes("loan")) interestCum += Math.round(amt * INTEREST_RATE);
    intSeries.push(interestCum);
  });

  const c1=document.getElementById("potChart").getContext("2d");
  if(potChart) potChart.destroy();
  potChart = new Chart(c1,{
    type:"line",
    data:{labels,datasets:[{label:"Pot",data:potSeries,tension:0.35}]},
    options:{responsive:true,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:"#9ca3af"},grid:{color:"rgba(31,41,55,.35)"}},
              y:{ticks:{color:"#9ca3af"},grid:{color:"rgba(31,41,55,.35)"}}}}
  });

  const c2=document.getElementById("interestChart").getContext("2d");
  if(interestChart) interestChart.destroy();
  interestChart = new Chart(c2,{
    type:"line",
    data:{labels,datasets:[{label:"Interest",data:intSeries,tension:0.35}]},
    options:{responsive:true,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:"#9ca3af"},grid:{color:"rgba(31,41,55,.35)"}},
              y:{ticks:{color:"#9ca3af"},grid:{color:"rgba(31,41,55,.35)"}}}}
  });
}

/* ===========================
   WRITE ACTIONS
=========================== */
async function addHistoryRow(type, member, amount, interestPercent=0, totalDue=null){
  const payload = { type, member, amount, interest_percent:interestPercent, total_due:totalDue };
  const r = await sb.from("history").insert([payload]);
  if(r.error) alert("History insert failed: " + r.error.message);
}

async function addMember(){
  const name=document.getElementById("mName").value.trim();
  const phone=document.getElementById("mPhone").value.trim();
  const hasBenefits=document.getElementById("mBenefits").value==="true";
  if(!name) return alert("Enter member name.");

  const pos = members.length ? Math.max(...members.map(x=>Number(x.position||0)))+1 : 1;
  const r = await sb.from("members").insert([{name,phone,has_benefits:hasBenefits,position:pos}]);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Member Added", name, 0, 0, null);
  document.getElementById("mName").value=""; document.getElementById("mPhone").value="";
  await reloadAll();
}

async function addContribution(){
  const memberId=document.getElementById("cMember").value;
  const amt=Number(document.getElementById("cAmount").value||0);
  if(!memberId) return alert("Select member.");
  if(!amt||amt<=0) return alert("Enter amount.");
  if(amt%500!==0) return alert("Amount must be multiple of 500.");

  const m=members.find(x=>String(x.id)===String(memberId));
  const newTotal=(Number(m.contributed)||0)+amt;

  const r=await sb.from("members").update({contributed:newTotal}).eq("id",memberId);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Contribution", m.name, amt, 0, newTotal);
  document.getElementById("cAmount").value="";
  await reloadAll();
}

async function setContribution(){
  const memberId=document.getElementById("cSetMember").value;
  const amt=Number(document.getElementById("cSetAmount").value||0);
  if(!memberId) return alert("Select member.");
  if(amt<0) return alert("Cannot be negative.");

  const m=members.find(x=>String(x.id)===String(memberId));
  const r=await sb.from("members").update({contributed:amt}).eq("id",memberId);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Set Contribution", m.name, amt, 0, amt);
  document.getElementById("cSetAmount").value="";
  await reloadAll();
}

async function addToFoundation(){
  const amt=Number(document.getElementById("fAmount").value||0);
  if(!amt||amt<=0) return alert("Enter amount.");

  const newFound=(Number(appState.foundation)||0)+amt;
  const r=await sb.from("app_state").update({foundation:newFound,updated_at:new Date().toISOString()}).eq("id",1);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Foundation Add","Admin",amt,0,newFound);
  document.getElementById("fAmount").value="";
  await reloadAll();
}

async function setFoundation(){
  const amt=Number(document.getElementById("fSetAmount").value||0);
  if(amt<0) return alert("Cannot be negative.");

  const r=await sb.from("app_state").update({foundation:amt,updated_at:new Date().toISOString()}).eq("id",1);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Foundation Set","Admin",amt,0,amt);
  document.getElementById("fSetAmount").value="";
  await reloadAll();
}

async function addMemberFoundation(){
  const memberId=document.getElementById("mfMember").value;
  const amt=Number(document.getElementById("mfAmount").value||0);
  if(!memberId) return alert("Select member.");
  if(!amt||amt<=0) return alert("Enter amount.");

  const m=members.find(x=>String(x.id)===String(memberId));
  const newMemberFound=(Number(m.foundation_contrib)||0)+amt;

  let r=await sb.from("members").update({foundation_contrib:newMemberFound}).eq("id",memberId);
  if(r.error) return alert(r.error.message);

  const newFound=(Number(appState.foundation)||0)+amt;
  r=await sb.from("app_state").update({foundation:newFound,updated_at:new Date().toISOString()}).eq("id",1);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Member Foundation",m.name,amt,0,newMemberFound);
  document.getElementById("mfAmount").value="";
  await reloadAll();
}

async function issueLoan(){
  const memberId=document.getElementById("lMember").value;
  const amt=Number(document.getElementById("lAmount").value||0);
  if(!memberId) return alert("Select member.");
  if(!amt||amt<=0) return alert("Enter loan amount.");

  const m=members.find(x=>String(x.id)===String(memberId));
  const foundation=Number(appState.foundation||0);
  if(amt>foundation) return alert("Loan cannot exceed foundation.");

  const minReq=0.70*amt;
  const memberFound=Number(m.foundation_contrib||0);
  if(m.has_benefits && memberFound<=minReq){
    return alert(`NOT QUALIFIED\nLoan: ${money(amt)}\n70% required: ${money(minReq)}\nMember foundation: ${money(memberFound)}`);
  }

  const interest=Math.round(amt*INTEREST_RATE);
  const totalDue=amt+interest;

  // member loan_due
  let r=await sb.from("members").update({loan_due:(Number(m.loan_due)||0)+totalDue}).eq("id",memberId);
  if(r.error) return alert(r.error.message);

  // app_state foundation & interest
  r=await sb.from("app_state").update({
    foundation: foundation-amt,
    total_interest_generated: (Number(appState.total_interest_generated)||0) + interest,
    updated_at:new Date().toISOString()
  }).eq("id",1);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Loan",m.name,amt,5,totalDue);
  document.getElementById("lAmount").value="";
  await reloadAll();
}

async function repayLoan(){
  const memberId=document.getElementById("rMember").value;
  const amt=Number(document.getElementById("rAmount").value||0);
  if(!memberId) return alert("Select member.");
  if(!amt||amt<=0) return alert("Enter repayment amount.");

  const m=members.find(x=>String(x.id)===String(memberId));
  const due=Number(m.loan_due||0);
  if(due<=0) return alert("No loan due.");

  const pay=Math.min(amt,due);
  const newDue=due-pay;

  let r=await sb.from("members").update({loan_due:newDue}).eq("id",memberId);
  if(r.error) return alert(r.error.message);

  r=await sb.from("app_state").update({
    foundation:(Number(appState.foundation)||0)+pay,
    updated_at:new Date().toISOString()
  }).eq("id",1);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Repayment",m.name,pay,0,newDue);
  document.getElementById("rAmount").value="";
  await reloadAll();
}

async function addFine(){
  const memberId=document.getElementById("fineMember").value;
  const amt=Number(document.getElementById("fineAmount").value||0);
  const reason=document.getElementById("fineReason").value.trim();
  if(!memberId) return alert("Select member.");
  if(!amt||amt<=0) return alert("Enter fine amount.");

  const m=members.find(x=>String(x.id)===String(memberId));
  const r=await sb.from("fines").insert([{
    member_id:m.id, member_name:m.name, amount:amt, reason, status:"unpaid"
  }]);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Fine",m.name,amt,0,null);
  document.getElementById("fineAmount").value="";
  document.getElementById("fineReason").value="";
  await reloadAll();
}

async function markFinePaid(fineId){
  const r=await sb.from("fines").update({status:"paid",paid_at:new Date().toISOString()}).eq("id",fineId);
  if(r.error) return alert(r.error.message);
  await reloadAll();
}

async function runPayout(){
  if(!members.length) return alert("No members.");

  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  if(pot<=0) return alert("Pot is 0.");

  const idx = Number(appState.next_payout_index||0) % members.length;
  const nextDate = appState.next_payout_date ? fromIso(appState.next_payout_date) : ROTATION_START;

  const today = fromIso(isoDate(new Date()));
  if(today < nextDate){
    return alert("Too early. Next payout: " + nextDate.toLocaleDateString());
  }

  const receiver = members[idx];

  // Save payout
  let r=await sb.from("payouts").insert([{
    member_id:receiver.id, member_name:receiver.name,
    payout_amount:pot, payout_date:isoDate(today)
  }]);
  if(r.error) return alert(r.error.message);

  // Update receiver payout_total
  r=await sb.from("members").update({
    payout_total:(Number(receiver.payout_total)||0)+pot,
    last_payout_at:new Date().toISOString()
  }).eq("id",receiver.id);
  if(r.error) return alert(r.error.message);

  // Reset contributions
  r=await sb.from("members").update({contributed:0});
  if(r.error) return alert(r.error.message);

  // Advance rotation
  const newIdx=(idx+1)%members.length;
  const newNextDate=new Date(nextDate.getTime()+BIWEEK_MS);
  r=await sb.from("app_state").update({
    next_payout_index:newIdx,
    next_payout_date:isoDate(newNextDate),
    updated_at:new Date().toISOString()
  }).eq("id",1);
  if(r.error) return alert(r.error.message);

  await addHistoryRow("Payout",receiver.name,pot,0,null);
  await reloadAll();
  alert(`✅ Paid ${money(pot)} to ${receiver.name}\nNext payout: ${newNextDate.toLocaleDateString()}`);
}

/* ===========================
   INIT (ALWAYS LOCK FIRST)
=========================== */
(async function init(){
  document.getElementById("app").style.display="none";
  document.getElementById("locked").style.display="flex";
  lockMsg("");

  // If already signed in, enforce gate
  const ok = await enforceAdminGate();
  if(ok) await reloadAll();
})();
</script>

</body>
</html>
